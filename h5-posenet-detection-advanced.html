<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸Šè‚¢åŠŸèƒ½åº·å¤å®æ—¶é‡åŒ–åˆ†æè½¯ä»¶</title>
  <link rel="icon" type="image/png" href="logo1.png">
  <style>
    :root {
      --primary-color: #1976D2;
      --primary-light: #E3F2FD;
      --success-color: #047857;
      --danger-color: #dc2626;
      --warning-color: #d97706;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --border-color: #d1d5db;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --header-bg: #1f2937;
      --header-text: #ffffff;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      background: #f8fafc;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      min-height: 100vh;
      color: var(--text-primary);
    }
    
    .site-header {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 1rem 0;
      text-align: center;
      width: 100%;
      box-shadow: var(--shadow-md);
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  gap: 20px;
    }
    
	.site-header h1 {
	  font-size: 24px;
	  font-weight: 600;
	  margin: 0;
	  display: flex;  /* ä¿ç•™åŸæœ‰flexï¼Œç”¨äºemojiå’Œæ ‡é¢˜çš„é—´è· */
	  align-items: center;
	  gap: 8px;
	  /* ç§»é™¤æˆ–æ³¨é‡Šæ‰ justify-content: center; å› ä¸ºç°åœ¨ç”±çˆ¶çº§flexæ§åˆ¶ */
	}
    
	#siteLogo {
	  height: 40px;  
	  width: auto;  
	  max-width: 100px;  
	  border-radius: 4px;  
	  transition: opacity 0.2s ease;  
	}
	
	#siteLogo:hover {
	  opacity: 0.8;  
	}
	
    .site-header h1::before {
    }
	
    .page-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }
    
    .header {
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }
    
    .header .time {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .header .time::before {
      content: "ğŸ“…";
    }
    
    .canvas-wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 10px;  
    }
    
    .container, .container2 {
      position: relative;
      background: var(--bg-primary);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      aspect-ratio: 4/3;
      border: 1px solid var(--border-color);
      transition: box-shadow 0.2s ease;
      flex-shrink: 0;
    }
    
    .container:hover, .container2:hover {
      box-shadow: var(--shadow-lg);
    }
    
    .canvas-title {
      position: absolute;
      top: 12px;
      left: 12px;
      background: var(--primary-color);
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      z-index: 10;
    }
    
    #video, #video2, #canvas, #canvas2 {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: scaleX(-1);
      object-fit: cover;
    }
    
    .debug-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
      transform: scaleX(-1);
    }
    
    .controls {
      display: flex;
      justify-content: space-evenly;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 20px;
      border: 1px solid transparent;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 120px;
      justify-content: center;
    }
    
    .start-btn {
      background: var(--success-color);
      color: white;
      border-color: var(--success-color);
    }
    
    .start-btn:hover {
      background: #065f46;
    }
    
    .analyze-btn {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .analyze-btn:hover {
      background: #1e3a8a;
    }
    
    .analyze-btn.active {
      background: var(--warning-color);
      border-color: var(--warning-color);
    }
    
    .stop-btn {
      background: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }
    
    .stop-btn:hover {
      background: #b91c1c;
    }
    
    button:disabled {
      background: var(--text-secondary);
      color: white;
      border-color: var(--text-secondary);
      cursor: not-allowed;
    }
    
    .score-section {
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }
    
    .score-item {
      margin-bottom: 20px;
      background: var(--bg-secondary);
      border-radius: 6px;
      padding: 16px;
      border: 1px solid var(--border-color);
    }
    
    .score-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .score-title {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .score-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .score-bar {
      height: 8px;
      background: var(--border-color);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .score-fill {
      height: 100%;
      background: var(--primary-color);
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .advice-section {
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
      border-left: 4px solid var(--primary-color);
    }
    
    .advice-section h3 {
      font-size: 18px;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .advice-section h3::before {
      content: "ğŸ’¡";
    }
    
    .advice-content {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    .advice-content li {
      margin: 10px 0;
      padding-left: 20px;
      position: relative;
    }
    
    .advice-content li::before {
      content: "âœ“";
      position: absolute;
      left: 0;
      color: var(--success-color);
      font-weight: bold;
    }
    
    .status {
      text-align: center;
      color: var(--text-secondary);
      margin: 15px 0;
      font-size: 14px;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }
    
    .tips {
      background: var(--primary-light);
      border-left: 4px solid var(--primary-color);
      padding: 12px;
      margin: 15px 0;
      border-radius: 6px;
      font-size: 14px;
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }
    
    .progress-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 400px;
      background: var(--bg-primary);
      padding: 24px;
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      display: none;
      z-index: 1000;
      border: 1px solid var(--border-color);
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border-color);
      border-radius: 3px;
      overflow: hidden;
      margin: 12px 0;
    }
    
    .progress-fill {
      width: 0%;
      height: 100%;
      background: var(--primary-color);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      text-align: center;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
      margin-top: 8px;
    }
    
    .fps {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .mode-switch {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: var(--bg-primary);
      padding: 6px;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }
    
    .mode-button {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .mode-button.active {
      background: var(--primary-color);
      color: white;
    }
    
    .upload-area {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-secondary);
      cursor: pointer;
      transition: background-color 0.2s ease;
      border: 2px dashed var(--border-color);
    }
    
    .upload-area:hover {
      background: var(--primary-light);
    }
    
    .upload-area.hidden {
      display: none;
    }
    
    .upload-icon {
      width: 60px;
      height: 60px;
      margin-bottom: 15px;
      color: var(--primary-color);
    }
    
    .upload-text {
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 500;
      text-align: center;
      margin-bottom: 6px;
    }
    
    .upload-hint {
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    #videoInput {
      display: none;
    }
    
    .success-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-primary);
      color: var(--success-color);
      padding: 12px 18px;
      border-radius: 6px;
      box-shadow: var(--shadow-lg);
      display: none;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      z-index: 2000;
      border: 1px solid var(--success-color);
    }
    
    .success-toast.show {
      display: flex;
    }
    
    .success-toast::before {
      content: "âœ…";
      font-size: 20px;
    }
    
    .device-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 20px;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction:  column;
      border: 1px solid var(--border-color);
    }
    
    .device-dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .device-dialog-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .device-dialog-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 4px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    
    .device-dialog-close:hover {
      background: var(--bg-secondary);
      color: var(--danger-color);
    }
    
    .device-selection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 15px;
      overflow-y: auto;
      flex: 1;
    }
    
    .device-section {
      background: var(--bg-secondary);
      border-radius: 6px;
      padding: 12px;
      border: 1px solid var(--border-color);
    }
    
    .device-section-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .device-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .device-item {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }
    
    .device-item:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow-sm);
    }
    
    .device-item.selected {
      border-color: var(--primary-color);
      background: var(--primary-light);
    }
    
    .device-item.selected::after {
      content: "âœ“";
      position: absolute;
      top: 6px;
      right: 6px;
      color: var(--primary-color);
      font-weight: bold;
    }
    
    .device-name {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 3px;
    }
    
    .device-info {
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    .device-type {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 500;
      margin-top: 3px;
    }
    
    .device-type.recommended {
      background: rgba(4, 120, 87, 0.1);
      color: var(--success-color);
    }
    
    .device-type.other {
      background: rgba(107, 114, 128, 0.1);
      color: var(--text-secondary);
    }
    
    .device-dialog-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }
    
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 999;
    }

    .site-footer {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 1rem 0;
      text-align: center;
      width: 100%;
      box-shadow: var(--shadow-md);
      margin-top: auto;
    }

    .time {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .time::before {
      content: "ğŸ“…";
    }

    .time-top {
      position: fixed;
      top: 100px;
      left: 20px;
      z-index: 100;
      background: var(--bg-primary);
      padding: 8px 12px;
      border-radius: 4px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }

    .time-bottom {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 100;
      background: var(--bg-primary);
      padding: 8px 12px;
      border-radius: 4px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }
    
    @media (max-width: 768px) {
	  .site-header {
		  justify-content: center;  /* ç§»åŠ¨ç«¯ï¼šlogoå’Œæ ‡é¢˜å‚ç›´å †å æˆ–å±…ä¸­ */
	      gap: 10px;  /* æ–°å¢ï¼šæ·»åŠ é—´è· */
		  }
		    
	  #siteLogo {
		  height: 30px;  /* ç§»åŠ¨ç«¯ç¼©å°logo */
		  order: -1;  /* å¯é€‰ï¼šè®©logoæ˜¾ç¤ºåœ¨æ ‡é¢˜å‰ */
		  }
		  
	  .site-header h1 {
		  font-size: 20px;  /* ä¿ç•™åŸæœ‰ç§»åŠ¨ç«¯è°ƒæ•´ */
	    }
		
      .page-container {
        padding: 12px;
      }
      
      /* æ›´æ–°åª’ä½“æŸ¥è¯¢ï¼šä¸å¼ºåˆ¶å•åˆ—ï¼Œè€Œæ˜¯å…è®¸æ»šåŠ¨ä¿æŒå¹¶æ’ */
      .canvas-wrapper {
        grid-template-columns: repeat(2, minmax(300px, 1fr));  /* æ”¹ä¸º2åˆ—ï¼Œä½†minmaxæ›´å°ï¼Œä¼˜å…ˆå¹¶æ’ */
        gap: 10px;
        /* æ–°å¢ï¼šå¦‚æœå±å¹•å¤ªçª„ï¼Œå¯ç”¨æ°´å¹³æ»šåŠ¨ */
        overflow-x: auto;
        justify-content: start;  /* å·¦å¯¹é½ï¼Œå…è®¸æ»šåŠ¨ */
      }
      
      .container, .container2 {
        flex-shrink: 0;  /* é˜²æ­¢å®¹å™¨å‹ç¼© */
        min-width: 300px;  /* æœ€å°å®½åº¦ï¼Œç¡®ä¿ä¸æŒ¤å‹ */
      }
      
      .controls {
        flex-direction: column;
      }
      
      button {
        flex: none;
        width: 100%;
      }
      
      .device-selection-grid {
        grid-template-columns: 1fr;
      }

      .site-header h1 {
        font-size: 20px;
      }

      .time-top {
        top: 80px;
        left: 12px;
      }

      .time-bottom {
        bottom: 12px;
        left: 12px;
      }
    }
	
    /* åŠ¨ä½œé¢æ¿æ ·å¼ */
    .action-btn {
      width: 100%;
      padding: 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      text-align: left;
    }
    .action-btn:hover { background: var(--primary-light); }
    .action-btn.active { 
      background: var(--primary-color); 
      color: white; 
      border-color: var(--primary-color);
    }
    .action-btn.has-data {
      border-left: 4px solid var(--success-color);
      background: #f0fdf4;
    }
    .action-data {
      margin-top: 10px;
      padding: 8px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    .data-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .data-row b { color: var(--text-primary); }
    .data-row .score-left, .data-row .score-right, .data-row .score-single, .data-row .val-sym {
      color: var(--success-color);
      font-weight: normal;
    }	
  </style>
</head>
<body>
  <header class="site-header">
	<img src="logo1.png" alt="Logo" id="siteLogo">
    <h1>ä¸Šè‚¢åŠŸèƒ½åº·å¤å®æ—¶é‡åŒ–åˆ†æè½¯ä»¶</h1>
  </header>

  <div class="page-container">
    <div class="time time-top"></div>
    
    <div id="debug" style="font-size: 12px; color: gray; margin: 5px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; display: none;"></div>
    
    <div class="mode-switch">
      <button class="mode-button active" id="cameraMode">
        ğŸ“· æ‘„åƒå¤´æ¨¡å¼
      </button>
      <button class="mode-button" id="videoMode">
        ğŸ“¹ è§†é¢‘ä¸Šä¼ æ¨¡å¼
      </button>
    </div>
    
    <div class="canvas-wrapper">
      <div class="container">
        <span class="canvas-title">ä¸»è§†è§’</span>
        <video id="video" playsinline></video>
        <canvas id="canvas"></canvas>
        <canvas id="debugCanvas" class="debug-overlay"></canvas>
        <div class="fps" id="fps">FPS: 0</div>
        <button id="debugToggle" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; border: none; padding: 5px; border-radius: 4px; font-size: 12px; display: none;">è°ƒè¯•</button>
        
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">åˆ†æä¸­...</div>
        </div>
        
        <div class="upload-area hidden" id="uploadArea">
          <svg class="upload-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
          </svg>
          <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
          <div class="upload-hint">æ”¯æŒMP4ã€MOVæ ¼å¼è§†é¢‘ï¼Œå¤§å°ä¸è¶…è¿‡200MB</div>
        </div>
        <input type="file" id="videoInput" accept="video/mp4,video/quicktime">
        
      </div>
      
      <div class="container2">
        <span class="canvas-title">è¾…åŠ©è§†è§’</span>
        <video id="video2" playsinline></video>
        <canvas id="canvas2"></canvas>
        <canvas id="debugCanvas2" class="debug-overlay"></canvas>
        <div class="fps" id="fps2">FPS: 0</div>
      </div>
    </div>
    
    <div class="controls">
      <button id="startBtn" class="start-btn">
        <span>ğŸš€</span> å¼€å§‹æ£€æµ‹
      </button>
      <button id="analyzeBtn" class="analyze-btn">
        <span>ğŸ“Š</span> å¼€å§‹åˆ†æåŠ¨ä½œ
      </button>
      <button id="actionTestBtn" class="analyze-btn" style="background-color: #8e44ad; border-color: #8e44ad; color: white;">
        <span>ğŸ‹ï¸</span> ä¸“ä¸šåŠ¨ä½œæµ‹è¯•
      </button>
      <button id="stopBtn" class="stop-btn">
        <span>â¹ï¸</span> åœæ­¢æ£€æµ‹
      </button>
      <button id="switchCameraBtn" style="display: none;" class="analyze-btn">
        <span>ğŸ”„</span> åˆ‡æ¢æ‘„åƒå¤´
      </button>
      <button id="debugRealSenseBtn" class="analyze-btn">
        <span>âš™ï¸</span> è®¾ç½®
      </button>
    </div>
	
	<div class="tips" id="detectionTips">
	    è¯·ç¡®ä¿ä¸ŠåŠèº«åœ¨ç”»å¸ƒä¸­åç‚¹å‡»å¼€å§‹æ£€æµ‹ï¼Œå¦‚æœéœ€åˆ†æåŠ¨ä½œè¯„åˆ†ï¼Œè¯·å†ç‚¹å‡»åˆ†æåŠ¨ä½œï¼Œåˆ†æåŠ¨ä½œæ—¶è¯·ç¡®ä¿å·¦å³æ‰‹è‡‚å…³é”®ç‚¹éƒ½æœ‰è¿çº¿åï¼Œå†è¿åŠ¨å‡ ç§’åç‚¹å‡»åœæ­¢åˆ†æå³å¯è¯„å‡ºåˆ†æ•°ã€‚
	</div>
    
    <div class="status" id="status">å‡†å¤‡å°±ç»ª</div>
    
    <div class="score-section" id="results" style="display: none;">
      <div class="score-item">
        <div class="score-header">
          <h3 class="score-title">
            <span>ğŸ¯</span> è‡ªç”±åº¦
          </h3>
          <span class="score-value"><span id="freedomScore">0</span>%</span>
        </div>
        <div class="score-bar">
          <div id="freedomBar" class="score-fill" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="score-item">
        <div class="score-header">
          <h3 class="score-title">
            <span>ğŸ”„</span> çµæ´»åº¦
          </h3>
          <span class="score-value"><span id="flexibilityScore">0</span>%</span>
        </div>
        <div class="score-bar">
          <div id="flexibilityBar" class="score-fill" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="score-item">
        <div class="score-header">
          <h3 class="score-title">
            <span>âš–ï¸</span> å¯¹ç§°åº¦
          </h3>
          <span class="score-value"><span id="symmetryScore">0</span>%</span>
        </div>
        <div class="score-bar">
          <div id="symmetryBar" class="score-fill" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="score-item">
        <div class="score-header">
          <h3 class="score-title">
            <span>ğŸ†</span> ç»¼åˆè¯„åˆ†
          </h3>
          <span class="score-value"><span id="accuracyScore">0</span>%</span>
        </div>
        <div class="score-bar">
          <div id="accuracyBar" class="score-fill" style="width: 0%"></div>
        </div>
      </div>
    </div>
    
    <!-- ã€ä¿®æ”¹ã€‘ç»¼åˆåŠ¨ä½œæµ‹è¯•ç»“æœé¢æ¿ -->
    <div class="score-section" id="actionTestPanel" style="display: none;">
      <div class="score-header">
        <h3 class="score-title">
          <span>ğŸ‹ï¸</span> åŠ¨ä½œæµ‹è¯•æ•°æ®
        </h3>
        <button id="closeActionPanel" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:20px;">Ã—</button>
      </div>
      
      <!-- åŠ¨ä½œæŒ‰é’®ç½‘æ ¼ -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px;">
        
        <!-- åŠ¨ä½œ1ï¼šè‚©å¤–ä¼¸ -->
        <div class="action-item" id="act_abduction">
          <button class="action-btn" onclick="startAction('abduction')">ğŸ™† è‚©å¤–ä¼¸</button>
          <div class="action-data" style="display:none;">
            <div class="data-row"><span>å·¦:</span> <b class="val-left">0Â°</b> <span class="score-left">(0åˆ†)</span></div>
            <div class="data-row"><span>å³:</span> <b class="val-right">0Â°</b> <span class="score-right">(0åˆ†)</span></div>
            <div class="data-row"><span>å¯¹ç§°:</span> <b class="val-sym">0åˆ†</b></div>
          </div>
        </div>

        <!-- åŠ¨ä½œ2ï¼šè‚©å‰æ›² -->
        <div class="action-item" id="act_forward">
          <button class="action-btn" onclick="startAction('forward')">â¡ï¸ è‚©å‰æ›²</button>
          <div class="action-data" style="display:none;">
            <div class="data-row"><span>å·¦:</span> <b class="val-left">0Â°</b> <span class="score-left">(0åˆ†)</span></div>
            <div class="data-row"><span>å³:</span> <b class="val-right">0Â°</b> <span class="score-right">(0åˆ†)</span></div>
            <div class="data-row"><span>å¯¹ç§°:</span> <b class="val-sym">0åˆ†</b></div>
          </div>
        </div>

        <!-- åŠ¨ä½œ3ï¼šè‚©åä¼¸ -->
        <div class="action-item" id="act_backward">
          <button class="action-btn" onclick="startAction('backward')">â¬…ï¸ è‚©åä¼¸</button>
          <div class="action-data" style="display:none;">
            <div class="data-row"><span>å·¦:</span> <b class="val-left">0Â°</b> <span class="score-left">(0åˆ†)</span></div>
            <div class="data-row"><span>å³:</span> <b class="val-right">0Â°</b> <span class="score-right">(0åˆ†)</span></div>
            <div class="data-row"><span>å¯¹ç§°:</span> <b class="val-sym">0åˆ†</b></div>
          </div>
        </div>

        <!-- åŠ¨ä½œ4ï¼šè‚©å¤–æ—‹ -->
        <div class="action-item" id="act_external">
          <button class="action-btn" onclick="startAction('external')">ğŸ™‹ è‚©å¤–æ—‹</button>
          <div class="action-data" style="display:none;">
            <div class="data-row"><span>å·¦:</span> <b class="val-left">0Â°</b> <span class="score-left">(0åˆ†)</span></div>
            <div class="data-row"><span>å³:</span> <b class="val-right">0Â°</b> <span class="score-right">(0åˆ†)</span></div>
            <div class="data-row"><span>å¯¹ç§°:</span> <b class="val-sym">0åˆ†</b></div>
          </div>
        </div>
		
        <!-- åŠ¨ä½œ5ï¼šè‚©å†…æ—‹ -->
        <div class="action-item" id="act_internal">
          <button class="action-btn" onclick="startAction('internal')">ğŸ™ è‚©å†…æ—‹</button>
          <div class="action-data" style="display:none;">
            <div class="data-row"><span>å·¦:</span> <b class="val-left">0Â°</b> <span class="score-left">(0åˆ†)</span></div>
            <div class="data-row"><span>å³:</span> <b class="val-right">0Â°</b> <span class="score-right">(0åˆ†)</span></div>
            <div class="data-row"><span>å¯¹ç§°:</span> <b class="val-sym">0åˆ†</b></div>
          </div>
        </div>

        <!-- åŠ¨ä½œ6ï¼šè‚˜æ›² -->
        <div class="action-item" id="act_elbow">
          <button class="action-btn" onclick="startAction('elbow')">ğŸ’ª è‚˜æ›²</button>
          <div class="action-data" style="display:none;">
            <div class="data-row"><span>å·¦:</span> <b class="val-left">0Â°</b> <span class="score-left">(0åˆ†)</span></div>
            <div class="data-row"><span>å³:</span> <b class="val-right">0Â°</b> <span class="score-right">(0åˆ†)</span></div>
            <div class="data-row"><span>å¯¹ç§°:</span> <b class="val-sym">0åˆ†</b></div>
          </div>
        </div>
      </div>

      <!-- ç»¼åˆæ€»åˆ† -->
      <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span style="font-weight:bold; font-size:16px;">ğŸ† ç»¼åˆåº·å¤è¯„åˆ†</span>
          <span id="totalScoreDisplay" style="font-size:24px; font-weight:bold; color:var(--primary-color);">0åˆ†</span>
        </div>
        <div class="score-bar" style="margin-top:5px; height:10px;">
          <div id="totalScoreBar" class="score-fill" style="width: 0%; background: linear-gradient(90deg, #8e44ad, #1976D2);"></div>
        </div>
        <div id="totalScoreDetail" style="font-size:12px; color:var(--text-secondary); margin-top:5px; text-align:right;">
          (éœ€å®Œæˆæ‰€æœ‰åŠ¨ä½œä»¥è®¡ç®—æ€»åˆ†)
        </div>
      </div>
	  
      <!-- Excel ä¿å­˜æŒ‰é’®åŒºåŸŸ -->
      <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #d1d5db;">
        <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
          
          <!-- æŒ‰é’®1ï¼šè®¾ç½®è·¯å¾„ -->
          <button id="setPathBtn" class="analyze-btn" style="flex: 1; min-width: 140px; background-color: #64748b; border-color: #64748b;">
            <span>ğŸ“</span> <span id="pathBtnText">è®¾ç½®ä¿å­˜è·¯å¾„</span>
          </button>
          
          <!-- æŒ‰é’®2ï¼šä¿å­˜ -->
          <button id="saveReportBtn" class="start-btn" style="flex: 1; min-width: 140px;" disabled>
            <span>ğŸ“¥</span> ä¿å­˜åˆ° Excel
          </button>
        </div>
        
        <!-- æç¤ºæ–‡å­— -->
        <div id="pathStatus" style="font-size: 12px; color: #6b7280; margin-top: 8px; text-align: center;">
          å½“å‰æ¨¡å¼ï¼šç›´æ¥ä¸‹è½½ (é»˜è®¤ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹)
        </div>
      </div>
    </div>

    <!--å®æ—¶è§’åº¦æç¤ºæ¡ -->
    <div id="liveAngleToast" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; display:none; z-index:2000; font-size:16px; font-weight:bold;">
      å®æ—¶è§’åº¦: <span id="liveAngleValue">0</span>Â°
    </div>
	
	
    <div class="advice-section" id="adviceSection" style="display: none;">
      <h3>ä¸“ä¸šå»ºè®®</h3>
      <div class="advice-content">
        <ul id="adviceList">
          <li>å½“å‰åŠ¨ä½œå¹…åº¦è¾ƒå°ï¼Œå»ºè®®é€‚å½“åŠ å¤§æ‰‹è‡‚æŠ¬èµ·è§’åº¦</li>
          <li>æ³¨æ„ä¿æŒåŠ¨ä½œç¨³å®šï¼Œé¿å…æ€¥ä¿ƒè¿åŠ¨</li>
          <li>å»ºè®®æ¯ç»„åš1-2åˆ†é’ŸåŒ€é€Ÿè®­ç»ƒ</li>
          <li>å¦‚æ„Ÿä¸é€‚è¯·åŠæ—¶æš‚åœå¹¶å’¨è¯¢åŒ»ç”Ÿ</li>
        </ul>
      </div>
    </div>


  </div>

  <footer class="site-footer">
    ç‰ˆæƒæ‰€æœ‰ Copyright 2025
  </footer>

  <div class="success-toast" id="successToast">
    æ£€æµ‹ç»“æœå·²æˆåŠŸä¿å­˜ï¼
  </div>

  <script src="./tfjs/tf.min.js"></script> 
  <script src="./tfjs/pose-detection.min.js"></script> 
  
  <!-- å¤„ç†excelæ–‡ä»¶çš„è¯»å†™è€Œå¯¼å…¥äº†sheetJSåº“ -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script>
	  
    // å…¨å±€å˜é‡
    let model;
    let detector;
    let video;
    let canvas;
    let ctx;
    let debugCanvas;
    let debugCtx;
    let isDetecting = false;
    let lastFpsUpdate = 0;
    let lastTime = 0;
    let frameCount = 0;
    let fps = 0;
    let currentStream = null;
    let debugMode = false;
    let isVideoMode = false;
    let uploadedVideo = null;
    let isFrontCamera = true;
    let isShoulderAbductionMode = false;
	
    // ç¬¬äºŒä¸ªè§†é¢‘å’Œç”»å¸ƒçš„å˜é‡
    let video2;
    let canvas2;
    let ctx2;
    let debugCanvas2;
    let debugCtx2;
    let currentStream2 = null;
    let fps2 = 0;
    let lastFpsUpdate2 = 0;
    let lastTime2 = 0;
    let frameCount2 = 0;
    
    let selectedDeviceId1 = null;
    let selectedDeviceId2 = null;
    
    // å…³é”®ç‚¹å¹³æ»‘å¤„ç†ç›¸å…³å˜é‡
    const SMOOTHING_FACTOR = 0.7;  // å¢å¼ºï¼šæ›´é«˜æƒé‡ï¼Œæ›´å¹³æ»‘
    const MIN_CONFIDENCE = 0.6;    // å¢å¼ºï¼šæ›´é«˜é˜ˆå€¼ï¼Œå‡å°‘å™ªå£°
    const BUFFER_SIZE = 3;         // æ–°å¢ï¼šç¼“å†²åŒºå¤§å°
    let previousKeypoints = null;
    let keypointBuffers = {};      // æ–°å¢ï¼šæ¯ä¸ªå…³é”®ç‚¹çš„ç¼“å†²åŒº
    let noPoseFrames1 = 0;         // æ–°å¢ï¼šæ— å§¿åŠ¿å¸§è®¡æ•°å™¨ï¼ˆç”»å¸ƒ1ï¼‰
    let noPoseFrames2 = 0;         // æ–°å¢ï¼šæ— å§¿åŠ¿å¸§è®¡æ•°å™¨ï¼ˆç”»å¸ƒ2ï¼‰
    const RESET_THRESHOLD = 5;    // ä¿®æ”¹ï¼šé™ä½é˜ˆå€¼ï¼Œæ›´å¿«é‡ç½®
    
    // æ‰‹è‡‚åŠ¨ä½œåˆ†ææ•°æ®
    let armMovementData = {
      left: [],
      right: [],
      recording: false
    };
    
    // åˆ†æç»“æœ
    let analysisResults = {
      symmetry: 0,
      freedom: 0,
      flexibility: 0
    };

    // DOMå…ƒç´ 
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const statusElem = document.getElementById('status');
    const fpsElem = document.getElementById('fps');
    const resultsElem = document.getElementById('results');
    const adviceSection = document.getElementById('adviceSection');
    
    // è®¾ç½®è§†é¢‘å’Œç”»å¸ƒå°ºå¯¸
    const VIDEO_WIDTH = 640;
    const VIDEO_HEIGHT = 480;

    const urlParams = new URLSearchParams(window.location.search);
    const userId = parseInt(urlParams.get('userId')) || 0;
    const username = urlParams.get('username') || 'unknown';
    console.log("getuserId",userId)
    console.log("getusername",username) 

    // æ˜¾ç¤ºæˆåŠŸæç¤º
    function showSuccessToast(message) {
      const toast = document.getElementById('successToast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // åˆå§‹åŒ–å…³é”®ç‚¹ç¼“å†²åŒº
    function initKeypointBuffers() {
      const keypointNames = [
        'nose', 'left_eye', 'right_eye', 'left_ear', 'right_ear',
        'left_shoulder', 'right_shoulder', 'left_elbow', 'right_elbow',
        'left_wrist', 'right_wrist', 'left_hip', 'right_hip',
        'left_knee', 'right_knee', 'left_ankle', 'right_ankle'
      ];
      keypointNames.forEach(name => {
        if (!keypointBuffers[name]) {
          keypointBuffers[name] = { positions: [], scores: [], missingFrames: 0 };
        } else {
          keypointBuffers[name].positions = [];
          keypointBuffers[name].scores = [];
          keypointBuffers[name].missingFrames = 0;
        }
      });
    }

    // åˆå§‹åŒ–å‡½æ•°
    async function init() {
      try {
        // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰debug=true
        const urlParams = new URLSearchParams(window.location.search);
        debugMode = urlParams.get('debug') === 'true';
        
        // ç§»é™¤è°ƒè¯•æŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘ï¼Œç¡®ä¿å§‹ç»ˆéšè—
        
        if (debugMode) {
          document.getElementById('debug').style.display = 'block';
          console.log('è°ƒè¯•æ¨¡å¼å·²å¯ç”¨');
        }
        
        // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        checkBrowserCompatibility();
        
        // è·å–è§†é¢‘å’Œç”»å¸ƒå…ƒç´ 
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        ctx = canvas.getContext('2d');
        
        // è·å–è°ƒè¯•ç”»å¸ƒ
        debugCanvas = document.getElementById('debugCanvas');
        debugCtx = debugCanvas.getContext('2d');
        
        // è·å–ç¬¬äºŒä¸ªè§†é¢‘å’Œç”»å¸ƒå…ƒç´ 
        video2 = document.getElementById('video2');
        canvas2 = document.getElementById('canvas2');
        ctx2 = canvas2.getContext('2d');
        debugCanvas2 = document.getElementById('debugCanvas2');
        debugCtx2 = debugCanvas2.getContext('2d');
        
        // è®¾ç½®è§†é¢‘å’Œç”»å¸ƒå°ºå¯¸
        [video, video2].forEach(v => {
          v.width = VIDEO_WIDTH;
          v.height = VIDEO_HEIGHT;
        });
        [canvas, canvas2].forEach(c => {
          c.width = VIDEO_WIDTH;
          c.height = VIDEO_HEIGHT;
        });
        [debugCanvas, debugCanvas2].forEach(dc => {
          dc.width = VIDEO_WIDTH;
          dc.height = VIDEO_HEIGHT;
        });

        // è®¾ç½®æ ·å¼
        [video, video2, canvas, canvas2, debugCanvas, debugCanvas2].forEach(el => {
          el.style.width = '100%';
          el.style.height = '100%';
        });
        
        // åŠ è½½MoveNetæ¨¡å‹
        model = poseDetection.SupportedModels.MoveNet;
        const modelConfig = {
          modelType: poseDetection.movenet.modelType.SINGLEPOSE_THUNDER,
          enableSmoothing: true,
        };
        
        statusElem.textContent = 'æ¨¡å‹åŠ è½½ä¸­...';
        detector = await poseDetection.createDetector(model, modelConfig);
        statusElem.textContent = 'æ¨¡å‹åŠ è½½æˆåŠŸï¼';
        
        // åˆå§‹åŒ–ç¼“å†²åŒº
        initKeypointBuffers();
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        startBtn.addEventListener('click', startDetection);
        stopBtn.addEventListener('click', stopDetection);
        analyzeBtn.addEventListener('click', toggleArmAnalysis);
		
		
        // é»˜è®¤ç¦ç”¨åœæ­¢æŒ‰é’®å’Œåˆ†ææŒ‰é’®
        stopBtn.disabled = true;
        analyzeBtn.disabled = true;
        
        // æ·»åŠ æ¨¡å¼åˆ‡æ¢ç›‘å¬
        document.getElementById('cameraMode').addEventListener('click', switchToCamera);
        document.getElementById('videoMode').addEventListener('click', switchToVideo);
        
        // æ·»åŠ è§†é¢‘ä¸Šä¼ ç›¸å…³ç›‘å¬
        const uploadArea = document.getElementById('uploadArea');
        const videoInput = document.getElementById('videoInput');
        
        uploadArea.addEventListener('click', () => videoInput.click());
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.style.background = 'var(--primary-light)';
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.style.background = 'var(--bg-secondary)';
        });
        
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.style.background = 'var(--bg-secondary)';
          
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleVideoFile(files[0]);
          }
        });
        
        videoInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            handleVideoFile(e.target.files[0]);
          }
        });
        
        // æ·»åŠ åˆ‡æ¢æ‘„åƒå¤´æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        switchCameraBtn.addEventListener('click', switchCamera);
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡ï¼Œæ˜¾ç¤ºåˆ‡æ¢æ‘„åƒå¤´æŒ‰é’®
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (isMobile) {
          switchCameraBtn.style.display = 'block';
        }

        // æ·»åŠ RealSenseè°ƒè¯•æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
        const debugRealSenseBtn = document.getElementById('debugRealSenseBtn');
        debugRealSenseBtn.addEventListener('click', showDeviceSelectionDialog);
        
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        statusElem.textContent = 'æ¨¡å‹åŠ è½½å¤±è´¥: ' + error.message;
      }
      
      window.addEventListener('resize', () => {
        setTimeout(updateCanvasSize, 200);
      });
    }
    
    // ==========================================
    // ã€æ–°ç³»ç»Ÿã€‘ä¸“ä¸šåŠ¨ä½œæµ‹è¯•é€»è¾‘
    // ==========================================
    
    // å…¨å±€çŠ¶æ€å˜é‡
    let isActionTestMode = false;
    let currentActionType = null; // å½“å‰æ­£åœ¨åšçš„åŠ¨ä½œ: 'abduction', 'forward', etc.
    
    // å­˜å‚¨æ¯ä¸ªåŠ¨ä½œçš„æœ€å¤§è§’åº¦æ•°æ®
    const actionData = {
      abduction: { left: 0, right: 0, sym: 0, done: false, norm: 180 }, // è‚©å¤–ä¼¸
      forward:   { left: 0, right: 0, sym: 0, done: false, norm: 180 }, // è‚©å‰æ›²
      backward:  { left: 0, right: 0, sym: 0, done: false, norm: 60 },  // è‚©åä¼¸ (å‡è®¾æ­£å¸¸60åº¦)
      external:  { left: 0, right: 0, sym: 0, done: false, norm: 180 }, // è‚©å¤–æ—‹
      internal:  { left: 0, right: 0, sym: 0, done: false, norm: 90 },  // è‚©å†…æ—‹ (å‡è®¾90åº¦)
      elbow:     { left: 0, right: 0, sym: 0, done: false, norm: 180 }  // è‚˜æ›²
    };

    // 1. æ‰“å¼€/å…³é—­ æ•´ä¸ªæµ‹è¯•é¢æ¿
    function toggleActionTestPanel() {
      isActionTestMode = !isActionTestMode;
      const panel = document.getElementById('actionTestPanel');
      const btn = document.getElementById('actionTestBtn');
      
      if (isActionTestMode) {
        panel.style.display = 'block';
        btn.innerHTML = '<span>ğŸš«</span> é€€å‡ºæµ‹è¯•';
        btn.classList.add('active');
        showSuccessToast('è¿›å…¥ä¸“ä¸šæµ‹è¯•æ¨¡å¼ï¼Œè¯·é€‰æ‹©ä¸‹æ–¹åŠ¨ä½œå¼€å§‹');
        // å…³é—­æ—§çš„åˆ†ææ¨¡å¼
        if (armMovementData.recording) toggleArmAnalysis();
      } else {
        panel.style.display = 'none';
        btn.innerHTML = '<span>ğŸ‹ï¸</span> ä¸“ä¸šåŠ¨ä½œæµ‹è¯•';
        btn.classList.remove('active');
        stopCurrentAction(); // åœæ­¢å½“å‰æ­£åœ¨è¿›è¡Œçš„åŠ¨ä½œ
      }
    }

    // 2. å¼€å§‹æŸä¸ªå…·ä½“åŠ¨ä½œ
    window.startAction = function(type) {
      if (!isActionTestMode) return;
      
      // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ­£åœ¨åšçš„åŠ¨ä½œï¼Œåˆ™åœæ­¢
      if (currentActionType === type) {
        stopCurrentAction();
        return;
      }
      
      // åœæ­¢ä¹‹å‰çš„åŠ¨ä½œ
      stopCurrentAction();
      
      // å¼€å§‹æ–°åŠ¨ä½œ
      currentActionType = type;
      
      // æ›´æ–°UIæŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('active'));
      const btn = document.querySelector(`#act_${type} .action-btn`);
      if(btn) btn.classList.add('active');
      
      // æ˜¾ç¤ºè¯¥åŠ¨ä½œçš„æ•°æ®é¢æ¿
      document.querySelectorAll('.action-data').forEach(d => d.style.display = 'none');
      const dataPanel = document.querySelector(`#act_${type} .action-data`);
      if(dataPanel) dataPanel.style.display = 'block';
      
      // æ˜¾ç¤ºå®æ—¶è§’åº¦æç¤º
      const toast = document.getElementById('liveAngleToast');
      toast.style.display = 'block';
      
      // æ ¹æ®åŠ¨ä½œç±»å‹ç»™æç¤º
      let msg = "";
      if (type === 'abduction') msg = "è¯·æ­£å¯¹é•œå¤´ï¼ŒåŒè‡‚ä¾§å¹³ä¸¾";
      if (type === 'forward') msg = "ã€ä¾§èº«æ¨¡å¼ã€‘è¯·ä¾§å¯¹é•œå¤´ï¼ŒæŠ¬èµ·æ‰‹è‡‚å‘å‰ä¼¸ç›´è¿›è¡Œæµ‹è¯•";
      if (type === 'backward') msg = "ã€ä¾§èº«æ¨¡å¼ã€‘è¯·ä¾§å¯¹å¯¹é•œå¤´ï¼ŒæŠ¬èµ·æ‰‹è‡‚å‘åä¼¸ç›´è¿›è¡Œæµ‹è¯•";
      if (type === 'external') msg = "è¯·æ­£å¯¹é•œå¤´ï¼Œå¤§è‡‚å¹³ä¸¾ï¼Œå°è‡‚å‘ä¸ŠæŠ¬";
      if (type === 'internal') msg = "è¯·æ­£å¯¹é•œå¤´ï¼Œå¤§è‡‚å¹³ä¸¾ï¼Œå°è‡‚å‘ä¸‹å‹";
      if (type === 'elbow') msg = "è¯·æ­£å¯¹é•œå¤´ï¼ŒåŒè‡‚å¹³ä¸¾å¹¶å¼¯æ›²";
      
      document.getElementById('liveAngleValue').textContent = "å‡†å¤‡ä¸­...";
      showSuccessToast(`å¼€å§‹æµ‹è¯•ï¼š${msg}`);
    };

    // 3. åœæ­¢å½“å‰åŠ¨ä½œ
    function stopCurrentAction() {
      if (!currentActionType) return;
      
      // ä¿å­˜æ•°æ®
      saveActionData(currentActionType);
      
      // é‡ç½®UI
      const btn = document.querySelector(`#act_${currentActionType} .action-btn`);
      if(btn) {
        btn.classList.remove('active');
        btn.classList.add('has-data'); // æ ‡è®°å·²æœ‰æ•°æ®
      }
      
      currentActionType = null;
      document.getElementById('liveAngleToast').style.display = 'none';
      
      // é‡æ–°è®¡ç®—æ€»åˆ†
      calculateTotalScore();
    }

    // 4. ä¿å­˜æ•°æ®åˆ°å¯¹è±¡
    function saveActionData(type) {
      const data = actionData[type];
      data.done = true;
      
      // æ ‡è®°æŒ‰é’®ä¸ºç»¿è‰²
      const btn = document.querySelector(`#act_${type} .action-btn`);
      if(btn) btn.classList.add('has-data');
    }

    // 5. è®¡ç®—æ€»åˆ†
    function calculateTotalScore() {
      let totalLeft = 0, totalRight = 0, totalSym = 0;
      let countLeft = 0, countRight = 0, countSym = 0;
      
      // éå†æ‰€æœ‰åŠ¨ä½œè®¡ç®—å¹³å‡åˆ†
      for (let key in actionData) {
        const d = actionData[key];
        if (!d.done) continue;
        
        if (d.left !== undefined) {
          totalLeft += (d.left / d.norm * 100); // å·¦è‡‚å¾—åˆ†
          countLeft++;
        }
        if (d.right !== undefined) {
          totalRight += (d.right / d.norm * 100); // å³è‡‚å¾—åˆ†
          countRight++;
        }
        if (d.sym !== undefined) {
          totalSym += d.sym; // å¯¹ç§°åº¦å·²ç»æ˜¯ç™¾åˆ†æ¯”äº†
          countSym++;
        }
        if (d.score !== undefined) {
           // å•è‡‚åŠ¨ä½œçš„åˆ†æ•°ç®—ä½œå·¦è‡‚ä¹Ÿç®—ä½œå³è‡‚ï¼ˆå–å¹³å‡ï¼‰
           const s = d.score; 
           totalLeft += s; totalRight += s;
           countLeft++; countRight++;
        }
      }
      
      let finalScore = 0;
      if (countLeft > 0 || countRight > 0) {
        const avgLeft = countLeft > 0 ? totalLeft / countLeft : 0;
        const avgRight = countRight > 0 ? totalRight / countRight : 0;
        const avgSym = countSym > 0 ? totalSym / countSym : 0;
        
        // ç»¼åˆåˆ† = (å·¦å¹³å‡ + å³å¹³å‡ + å¯¹ç§°å¹³å‡) / 3
        finalScore = (avgLeft + avgRight + avgSym) / 3;
      }
      
      finalScore = Math.round(finalScore);
      document.getElementById('totalScoreDisplay').textContent = `${finalScore}åˆ†`;
      document.getElementById('totalScoreBar').style.width = `${finalScore}%`;
      
      const detail = `å·¦è‡‚å¹³å‡: ${countLeft?Math.round(totalLeft/countLeft):0}åˆ† | å³è‡‚å¹³å‡: ${countRight?Math.round(totalRight/countRight):0}åˆ† | å¯¹ç§°åº¦: ${countSym?Math.round(totalSym/countSym):0}åˆ†`;
      document.getElementById('totalScoreDetail').textContent = detail;
	  
	  // æœ‰åˆ†æ•°å°±ç‚¹äº®â€œä¿å­˜â€æŒ‰é’®
      const saveBtn = document.getElementById('saveReportBtn');
      if (saveBtn && (countLeft > 0 || countRight > 0)) {
        saveBtn.disabled = false;
      }
    }


    // 6. å®æ—¶æ›´æ–°å¾ªç¯ 
    function updateActionSystem(keypoints) {
      if (!isActionTestMode || !currentActionType) return;
      
      const type = currentActionType;
      let angleL = 0, angleR = 0; // å·¦è‡‚è§’åº¦ï¼Œå³è‡‚è§’åº¦
      let displayText = ""; // åº•éƒ¨æç¤ºæ¡çš„æ–‡å­—

      // è·å–å…³é”®ç‚¹
      const ls = findKeypoint(keypoints, 'left_shoulder');
      const rs = findKeypoint(keypoints, 'right_shoulder');
      const le = findKeypoint(keypoints, 'left_elbow');
      const re = findKeypoint(keypoints, 'right_elbow');
      const lw = findKeypoint(keypoints, 'left_wrist');
      const rw = findKeypoint(keypoints, 'right_wrist');
      const lhip = findKeypoint(keypoints, 'left_hip');
      const rhip = findKeypoint(keypoints, 'right_hip');

      // è®¡ç®—èº«ä½“ä¸­å¿ƒç‚¹ (ç”¨äºè‚©å¤–å±•çš„èº«ä½“ä¾§é¢åŸºå‡†)
      let centerX = 0, centerY = 0;
      if (ls && rs && lhip && rhip) {
        centerX = (ls.x + rs.x + lhip.x + rhip.x) / 4;
        centerY = (ls.y + rs.y + lhip.y + rhip.y) / 4;
      }

      // --- åŠ¨ä½œ 1ï¼šè‚©å¤–å±• ---
      if (type === 'abduction') {
        if (ls && le && centerX !== 0) {
          // å·¦ï¼šå·¦é«‹ -> å·¦è‚© -> å·¦è‚˜
          angleL = calculateAngle(ls.x, ls.y, le.x, le.y, lhip.x, lhip.y);
        }
        if (rs && re && centerX !== 0) {
          // å³ï¼šå³é«‹ -> å³è‚© -> å³è‚˜
          angleR = calculateAngle(rs.x, rs.y, re.x, re.y, rhip.x, rhip.y);
        }
        displayText = `å·¦: ${Math.round(angleL)}Â° | å³: ${Math.round(angleR)}Â°`;
        
        if(angleL > actionData.abduction.left) actionData.abduction.left = angleL;
        if(angleR > actionData.abduction.right) actionData.abduction.right = angleR;
      } 
      
      // --- åŠ¨ä½œ 2ï¼šè‚©å‰æ›² (æ”¹å›ä¾§èº«æ¨¡å¼ + åŒºåˆ†å·¦å³è‡‚) ---
        else if (type === 'forward') {
            // 1. æ™ºèƒ½è¯†åˆ«å½“å‰æ˜¯åœ¨æµ‹è¯•å·¦è‡‚è¿˜æ˜¯å³è‡‚
            const arm = getBestVisibleArm(ls, le, lw, rs, re, rw, lhip, rhip);
             if (arm) {
               // å¦‚æœæ˜¯å·¦ä¾§æ‰‹ (shoulder name åŒ…å« 'left')
               if (arm.shoulder.name.includes('left')) {
                 angleL = 180 - calculateAngle(lhip.x, lhip.y, ls.x, ls.y, le.x, le.y);
                 angleR = 0; // å³è‡‚ä¸å‚ä¸æµ‹è¯•ï¼Œå¼ºåˆ¶ä¸º0
                 displayText = `å·¦è‡‚: ${Math.round(angleL)}Â° (å³è‡‚æœªæ£€æµ‹)`;
                 
                 // å­˜å…¥æ•°æ®
                 if(angleL > actionData.forward.left) actionData.forward.left = angleL;
                 // ä¿æŒ rightè‡‚ä¸º0æˆ–ä¸Šä¸€æ¬¡çš„æœ‰æ•ˆå€¼ï¼Ÿ
                 // è¿™é‡Œæˆ‘ä»¬é€‰æ‹©è®©æœªæ£€æµ‹çš„æ‰‹è‡‚ä¿æŒæ˜¾ç¤ºä¸º0æˆ–ä¸æ›´æ–°æœ€å¤§å€¼
                 if (actionData.forward.right === 0) actionData.forward.right = 0; 
               
               } 
               // å¦‚æœæ˜¯å³ä¾§æ‰‹
               else if (arm.shoulder.name.includes('right')) {
                 angleR = 180 - calculateAngle(rhip.x, rhip.y, rs.x, rs.y, re.x, re.y);
                 angleL = 0;
                 displayText = `å³è‡‚: ${Math.round(angleR)}Â° (å·¦è‡‚æœªæ£€æµ‹)`;
                 
                 if(angleR > actionData.forward.right) actionData.forward.right = angleR;
                 if (actionData.forward.left === 0) actionData.forward.left = 0;
               }
             }
           }
           
          // --- åŠ¨ä½œ 3ï¼šè‚©åä¼¸ (æ”¹å›ä¾§èº«æ¨¡å¼ + åŒºåˆ†å·¦å³è‡‚) ---
          else if (type === 'backward') {
             // 1. æ™ºèƒ½è¯†åˆ«å½“å‰æ˜¯åœ¨æµ‹è¯•å·¦è‡‚è¿˜æ˜¯å³è‡‚
             const arm = getBestVisibleArm(ls, le, lw, rs, re, rw, lhip, rhip);
             
             if (arm && arm.shoulder && arm.elbow && arm.hip) {
               // è®¡ç®—è‚©éƒ¨è§’åº¦ (é«‹-è‚©-è‚˜)
               const angle = calculateAngle(arm.hip.x, arm.hip.y, arm.shoulder.x, arm.shoulder.y, arm.elbow.x, arm.elbow.y);
               
               if (arm.shoulder.name.includes('left')) {
                 angleL = angle;
                 angleR = 0;
                 displayText = `å·¦è‡‚: ${Math.round(angle)}Â° (å³è‡‚æœªæ£€æµ‹)`;
                 if(angle > actionData.backward.left) actionData.backward.left = angle;
                 if (actionData.backward.right === 0) actionData.backward.right = 0;
               } else {
                 angleR = angle;
                 angleL = 0;
                 displayText = `å³è‡‚: ${Math.round(angle)}Â° (å·¦è‡‚æœªæ£€æµ‹)`;
                 if(angle > actionData.backward.right) actionData.backward.right = angle;
                 if (actionData.backward.left === 0) actionData.backward.left = 0;
               }
             }
           }
      
      // --- åŠ¨ä½œ 4ï¼šè‚©å¤–æ—‹ (æ”¹ä¸ºæ­£å¯¹åŒè‡‚æ¨¡å¼) ---
      // é€»è¾‘ï¼šè®¡ç®—å°è‡‚ (è‚˜-è…•) ä¸ ç»å¯¹æ°´å¹³çº¿çš„å¤¹è§’
      else if (type === 'external') {
        if (le && lw) {
          // è®¡ç®—å°è‡‚ç›¸å¯¹äºæ°´å¹³çº¿çš„è§’åº¦ (å‘ä¸Šä¸ºæ­£)
          const rawAngle = getAngleFromHorizontal(le.x, le.y, lw.x, lw.y);
          // Math.abs å–ç»å¯¹å€¼ï¼Œä¸ç®¡æ˜¯å‘ä¸ŠæŠ¬è¿˜æ˜¯å‘ä¸‹å‹ï¼Œéƒ½æ˜¾ç¤ºåç¦»åº¦
          // å¦‚æœåªæƒ³è¦å‘ä¸ŠæŠ¬çš„è§’åº¦ï¼Œå¯ä»¥å»æ‰ Math.absï¼Œå¹¶æ ¹æ®æ­£è´Ÿåˆ¤æ–­
          // è¿™é‡Œå‡è®¾å‘ä¸ŠæŠ¬æ˜¯æ­£ï¼Œæ‰€ä»¥å–ç»å¯¹å€¼å³å¯
          angleL = 180 - Math.abs(rawAngle); 
        }
        if (re && rw) {
          const rawAngle = getAngleFromHorizontal(re.x, re.y, rw.x, rw.y);
          angleR = 180 - Math.abs(rawAngle);
        }
        displayText = `å·¦: ${Math.round(angleL)}Â° | å³: ${Math.round(angleR)}Â°`;
        
        if(angleL > actionData.external.left) actionData.external.left = angleL;
        if(angleR > actionData.external.right) actionData.external.right = angleR;
      }
      
      // --- åŠ¨ä½œ 5ï¼šè‚©å†…æ—‹ (æ”¹ä¸ºæ­£å¯¹åŒè‡‚æ¨¡å¼) ---
      // é€»è¾‘ï¼šåŒè‚©å¤–æ—‹ï¼Œè®¡ç®—å°è‡‚ä¸æ°´å¹³çº¿å¤¹è§’
      else if (type === 'internal') {
        if (le && lw) {
          const rawAngle = getAngleFromHorizontal(le.x, le.y, lw.x, lw.y);
          angleL = 180 - Math.abs(rawAngle);
        }
        if (re && rw) {
          const rawAngle = getAngleFromHorizontal(re.x, re.y, rw.x, rw.y);
          angleR = 180 - Math.abs(rawAngle);
        }
        displayText = `å·¦: ${Math.round(angleL)}Â° | å³: ${Math.round(angleR)}Â°`;
        
        if(angleL > actionData.internal.left) actionData.internal.left = angleL;
        if(angleR > actionData.internal.right) actionData.internal.right = angleR;
      }
      
      // --- åŠ¨ä½œ 6ï¼šè‚˜æ›² (æ­£å¯¹) ---
      // é€»è¾‘ï¼š180 - (è‚©-è‚˜-è…•) å¤¹è§’
      else if (type === 'elbow') {
        if (ls && le && lw) {
          const rawL = calculateAngle(ls.x, ls.y, le.x, le.y, lw.x, lw.y);
          if (rawL > 175) {
            rawL = 180;
          }
          
          angleL = 180 - rawL - 45;
        }
        if (rs && re && rw) {
          const rawR = calculateAngle(rs.x, rs.y, re.x, re.y, rw.x, rw.y);
          if (rawR > 175) {
            rawR = 180;
          }
          
          angleR = 180 - rawR - 45;
        }
        displayText = `å·¦: ${Math.round(angleL)}Â° | å³: ${Math.round(angleR)}Â°`;
        
        if(angleL > actionData.elbow.left) actionData.elbow.left = angleL;
        if(angleR > actionData.elbow.right) actionData.elbow.right = angleR;
      }

      // --- æ›´æ–°UIæ˜¾ç¤º ---
      // æ›´æ–°åº•éƒ¨é»‘è‰²æç¤ºæ¡
      const toastEl = document.getElementById('liveAngleValue');
      if(toastEl) toastEl.textContent = displayText;
      
      // æ›´æ–°é¢æ¿æ•°æ®
      updateActionPanelUI(type, angleL, angleR);
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–ç‚¹ç›¸å¯¹äºå‚çº¿çš„è§’åº¦ (0åº¦ä¸‹å‚, 180åº¦ä¸Šä¸¾)
    function getAngleFromVertical(px, py, cx, cy) {
      const dx = px - cx;
      const dy = py - cy; 
      const rad = Math.atan2(dy, dx);
      let deg = rad * (180 / Math.PI);
      let result = 90 - deg;
      if (result < 0) result += 360; // å¤„ç†è´Ÿè§’åº¦
      if (result > 180) result = 360 - result; // å½’ä¸€åŒ–åˆ°0-180
      return Math.round(result);
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–çº¿æ®µç›¸å¯¹äºæ°´å¹³çº¿çš„è§’åº¦
    function getAngleFromHorizontal(x1, y1, x2, y2) {
      const dx = x2 - x1;
      const dy = y2 - y1;
      const rad = Math.atan2(dy, dx);
      return rad * (180 / Math.PI);
    }

    // æ™ºèƒ½è¯†åˆ«å¯è§æ‰‹è‡‚ (é…åˆå¼ºåˆ¶æ£€æµ‹æ¨¡å¼)
    function getBestVisibleArm(ls, le, lw, rs, re, rw, lhip, rhip) {
      // 1. è®¡ç®—å·¦å³æ‰‹çš„â€œå¯è§æ€§å¾—åˆ†â€ (å³ä½¿ç½®ä¿¡åº¦ä½ï¼Œåªè¦æœ‰åæ ‡å°±ç®—åˆ†)
      let leftScore = (ls ? 1 : 0) + (le ? 1 : 0) + (lw ? 1 : 0);
      let rightScore = (rs ? 1 : 0) + (re ? 1 : 0) + (rw ? 1 : 0);

      // 2. åˆ¤æ–­æ˜¯å¦ä¾§èº«ï¼šå¦‚æœä¸€åªæ‰‹çš„å®Œæ•´åº¦è¿œé«˜äºå¦ä¸€åª
      const isLeftDominant = leftScore > rightScore * 1.5;
      const isRightDominant = rightScore > leftScore * 1.5;

      // 3. å¼ºåˆ¶è¿”å›ä¼˜åŠ¿æ‰‹
      if (isLeftDominant && leftScore >= 2) {
        return { shoulder: ls, elbow: le, wrist: lw, hip: lhip };
      } else if (isRightDominant && rightScore >= 2) {
        return { shoulder: rs, elbow: re, wrist: rw, hip: rhip };
      }

      // 4. å¦‚æœä¸åˆ†ä¼¯ä»²ï¼Œè¿”å›å®Œæ•´åº¦è¾ƒé«˜çš„
      if (leftScore >= rightScore && leftScore >= 2) {
        return { shoulder: ls, elbow: le, wrist: lw, hip: lhip };
      } else if (rightScore >= 2) {
        return { shoulder: rs, elbow: re, wrist: rw, hip: rhip };
      }
      return null;
    }

    // å®æ—¶æ›´æ–°é¢æ¿ä¸Šçš„æ•°å€¼
    function updateActionPanelUI(type, val1, val2) {
      // æ›´æ–°æœ€å¤§å€¼å­˜å‚¨ï¼ˆåœ¨ updateActionSystem ä¸­å·²åšï¼Œè¿™é‡Œåªåšæ˜¾ç¤ºï¼‰
      // æ ¹æ®ä¸åŒç±»å‹æ›´æ–°DOM
      if (type === 'abduction') {
        const d = actionData.abduction;
        const sym = d.left > 0 ? (Math.min(d.left, d.right) / Math.max(d.left, d.right) * 100) : 0;
        d.sym = Math.round(sym);
        
        updateVal('#act_abduction .val-left', d.left);
        updateVal('#act_abduction .val-right', d.right);
        updateScore('#act_abduction .score-left', d.left, 180);
        updateScore('#act_abduction .score-right', d.right, 180);
        updateScore('#act_abduction .val-sym', d.sym, 100, false);
      }
      else if (type === 'elbow') {
        const d = actionData.elbow;
        const sym = d.left > 0 ? (Math.min(d.left, d.right) / Math.max(d.left, d.right) * 100) : 0;
        d.sym = Math.round(sym);
        
        updateVal('#act_elbow .val-left', d.left);
        updateVal('#act_elbow .val-right', d.right);
        updateScore('#act_elbow .score-left', d.left, 180);
        updateScore('#act_elbow .score-right', d.right, 180);
        updateScore('#act_elbow .val-sym', d.sym, 100, false);
      }
      else {
        const d = actionData[type];
        
        // è®¡ç®—å¯¹ç§°åº¦
        const sym = (d.left > 0 && d.right > 0) ? (Math.min(d.left, d.right) / Math.max(d.left, d.right) * 100) : 0;
        d.sym = Math.round(sym);
        
        // æ›´æ–°å·¦è‡‚
        updateVal(`#act_${type} .val-left`, d.left);
        updateScore(`#act_${type} .score-left`, d.left, d.norm);
        
        // æ›´æ–°å³è‡‚
        updateVal(`#act_${type} .val-right`, d.right);
        updateScore(`#act_${type} .score-right`, d.right, d.norm);
        
        // æ›´æ–°å¯¹ç§°åº¦
        updateScore(`#act_${type} .val-sym`, d.sym, 100, false);
      }
    }

    function updateVal(selector, val) {
      const el = document.querySelector(selector);
      if(el) el.textContent = Math.round(val) + 'Â°';
    }
    
    function updateScore(selector, val, max, isPercent=true) {
      const el = document.querySelector(selector);
      if(el) {
        const s = Math.round((val / max) * 100);
        el.textContent = isPercent ? `(${s}åˆ†)` : `${s}åˆ†`;
      }
    }

    // åˆå§‹åŒ–äº‹ä»¶ç»‘å®š
    document.getElementById('actionTestBtn').addEventListener('click', toggleActionTestPanel);
    document.getElementById('closeActionPanel').addEventListener('click', toggleActionTestPanel);
    // ç»‘å®š Excel æŒ‰é’®åŠŸèƒ½
    document.getElementById('setPathBtn').addEventListener('click', setSavePath);
    document.getElementById('saveReportBtn').addEventListener('click', saveToExcel);
	
	
    // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
    function checkBrowserCompatibility() {
      const debugElem = document.getElementById('debug');
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        const msg = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´APIï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–Edgeæµè§ˆå™¨';
        statusElem.textContent = msg;
        if (debugElem) {
          debugElem.textContent += msg + '\n';
        }
        return false;
      }
      
      return true;
    }
    
    // è‡ªåŠ¨é€‰æ‹©é»˜è®¤è®¾å¤‡ï¼ˆæ–°å¢å‡½æ•°ï¼‰
    async function autoSelectDevices() {
      try {
        // å…ˆè¯·æ±‚æ‘„åƒå¤´æƒé™ä»¥è·å–è®¾å¤‡æ ‡ç­¾ï¼ˆä¸´æ—¶æµï¼Œç«‹å³åœæ­¢ï¼‰
        const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
        tempStream.getTracks().forEach(track => track.stop());

        // è·å–è®¾å¤‡åˆ—è¡¨
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');

        // é‡ç½®é€‰ä¸­ID
        selectedDeviceId1 = null;
        selectedDeviceId2 = null;

        // ä¸»è§†è§’ä½¿ç”¨RGBç›¸æœº
        for (let device of videoDevices) {
          const label = device.label.toLowerCase();
          if (label.includes('intel(r) realsense(tm) depth camera 435i rgb') || label.includes('435i rgb')) {
            selectedDeviceId1 = device.deviceId;
            console.log('ä¸»è§†è§’é»˜è®¤è®¾å¤‡å·²é€‰æ‹©:', device.label);
            break;
          }
        }

        // è¾…åŠ©è§†è§’ä½¿ç”¨æ·±åº¦ç›¸æœº
        for (let device of videoDevices) {
          const label = device.label.toLowerCase();
          if (label.includes('intel(r) realsense(tm) depth camera 435i depth') || label.includes('435i depth')) {
            selectedDeviceId2 = device.deviceId;
            console.log('è¾…åŠ©è§†è§’é»˜è®¤è®¾å¤‡å·²é€‰æ‹©:', device.label);
            break;
          }
        }

        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šè®¾å¤‡ï¼Œå›é€€åˆ°é»˜è®¤è®¾å¤‡ï¼ˆåˆ—è¡¨ç¬¬ä¸€ä¸ªï¼‰
        if (!selectedDeviceId1) {
          if (videoDevices.length > 0) {
            selectedDeviceId1 = videoDevices[0].deviceId;
            console.log('ä¸»è§†è§’å›é€€åˆ°é»˜è®¤è®¾å¤‡:', videoDevices[0].label);
          }
        }
        if (!selectedDeviceId2 && videoDevices.length > 1) {
          // é¿å…ä¸ä¸»è§†è§’é‡å¤
          for (let device of videoDevices) {
            if (device.deviceId !== selectedDeviceId1) {
              selectedDeviceId2 = device.deviceId;
              console.log('è¾…åŠ©è§†è§’å›é€€åˆ°é»˜è®¤è®¾å¤‡:', device.label);
              break;
            }
          }
        }

        statusElem.textContent = `é»˜è®¤è®¾å¤‡å·²è®¾ç½® - ä¸»è§†è§’: ${selectedDeviceId1 ? 'å·²é€‰æ‹©' : 'æ— '}ï¼Œè¾…åŠ©è§†è§’: ${selectedDeviceId2 ? 'å·²é€‰æ‹©' : 'æ— '}`;
      } catch (error) {
        console.error('è‡ªåŠ¨é€‰æ‹©è®¾å¤‡å¤±è´¥:', error);
        statusElem.textContent = 'è‡ªåŠ¨é€‰æ‹©è®¾å¤‡å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤æ‘„åƒå¤´';
      }
    }
    
    // æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©å¯¹è¯æ¡†
    async function showDeviceSelectionDialog() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
		
        // åˆ›å»ºé®ç½©å±‚
        const overlay = document.createElement('div');
        overlay.className = 'dialog-overlay';
        overlay.onclick = () => {
          document.body.removeChild(overlay);
          document.body.removeChild(dialog);
        };
        
        // åˆ›å»ºå¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.className = 'device-dialog';
        
        // å¯¹è¯æ¡†å¤´éƒ¨
        const header = document.createElement('div');
        header.className = 'device-dialog-header';
        
        const title = document.createElement('div');
        title.className = 'device-dialog-title';
        title.innerHTML = '<span>âš™ï¸</span> æ‘„åƒå¤´è®¾ç½®';
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'device-dialog-close';
        closeBtn.innerHTML = 'Ã—';
        closeBtn.onclick = () => {
          document.body.removeChild(overlay);
          document.body.removeChild(dialog);
        };
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        dialog.appendChild(header);
        
        // è®¾å¤‡é€‰æ‹©åŒºåŸŸ
        const selectionGrid = document.createElement('div');
        selectionGrid.className = 'device-selection-grid';
        
        // ç”»å¸ƒ1è®¾å¤‡é€‰æ‹©
        const canvas1Section = document.createElement('div');
        canvas1Section.className = 'device-section';
        
        const canvas1Title = document.createElement('div');
        canvas1Title.className = 'device-section-title';
        canvas1Title.innerHTML = '<span>ğŸ“¹</span> ä¸»è§†è§’æ‘„åƒå¤´';
        
        const canvas1List = document.createElement('div');
        canvas1List.className = 'device-list';
        
        // æ·»åŠ è‡ªåŠ¨é€‰æ‹©é€‰é¡¹
        const autoItem1 = createDeviceItem({
          deviceId: null,
          label: 'è‡ªåŠ¨é€‰æ‹©',
          isRecommended: true
        }, 'canvas1');
        canvas1List.appendChild(autoItem1);
        
        // æ·»åŠ å®é™…è®¾å¤‡
        videoDevices.forEach((device, index) => {
          const deviceInfo = analyzeDevice(device);
          const deviceItem = createDeviceItem({
            deviceId: device.deviceId,
            label: device.label || `æ‘„åƒå¤´ ${index + 1}`,
            type: deviceInfo.type,
            isRecommended: deviceInfo.isRecommended
          }, 'canvas1');
          canvas1List.appendChild(deviceItem);
        });
        
        canvas1Section.appendChild(canvas1Title);
        canvas1Section.appendChild(canvas1List);
        selectionGrid.appendChild(canvas1Section);
        
        // ç”»å¸ƒ2è®¾å¤‡é€‰æ‹©
        const canvas2Section = document.createElement('div');
        canvas2Section.className = 'device-section';
        
        const canvas2Title = document.createElement('div');
        canvas2Title.className = 'device-section-title';
        canvas2Title.innerHTML = '<span>ğŸ“¹</span> è¾…åŠ©è§†è§’æ‘„åƒå¤´';
        
        const canvas2List = document.createElement('div');
        canvas2List.className = 'device-list';
        
        // æ·»åŠ è‡ªåŠ¨é€‰æ‹©é€‰é¡¹
        const autoItem2 = createDeviceItem({
          deviceId: null,
          label: 'è‡ªåŠ¨é€‰æ‹©',
          isRecommended: true
        }, 'canvas2');
        canvas2List.appendChild(autoItem2);
        
        // æ·»åŠ å®é™…è®¾å¤‡
        videoDevices.forEach((device, index) => {
          const deviceInfo = analyzeDevice(device);
          const deviceItem = createDeviceItem({
            deviceId: device.deviceId,
            label: device.label || `æ‘„åƒå¤´ ${index + 1}`,
            type: deviceInfo.type,
            isRecommended: deviceInfo.isRecommended
          }, 'canvas2');
          canvas2List.appendChild(deviceItem);
        });
        
        canvas2Section.appendChild(canvas2Title);
        canvas2Section.appendChild(canvas2List);
        selectionGrid.appendChild(canvas2Section);
        
        dialog.appendChild(selectionGrid);
        
        // å¯¹è¯æ¡†åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.className = 'device-dialog-footer';
        
        const testBtn = document.createElement('button');
        testBtn.className = 'analyze-btn';
        testBtn.innerHTML = '<span>ğŸ”</span> æµ‹è¯•';
        testBtn.onclick = async () => {
          try {
            await testSelectedDevices();
            showSuccessToast('è®¾å¤‡æµ‹è¯•æˆåŠŸï¼');
          } catch (error) {
            showSuccessToast('è®¾å¤‡æµ‹è¯•å¤±è´¥ï¼š' + error.message);
          }
        };
        
        const applyBtn = document.createElement('button');
        applyBtn.className = 'start-btn';
        applyBtn.innerHTML = '<span>âœ…</span> åº”ç”¨';
        applyBtn.onclick = async () => {
          try {
            await applyDeviceSelection();
            document.body.removeChild(overlay);
            document.body.removeChild(dialog);
            showSuccessToast('æ‘„åƒå¤´è®¾ç½®å·²åº”ç”¨ï¼');
          } catch (error) {
            showSuccessToast('åº”ç”¨å¤±è´¥ï¼š' + error.message);
          }
        };
        
        footer.appendChild(testBtn);
        footer.appendChild(applyBtn);
        dialog.appendChild(footer);
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(overlay);
        document.body.appendChild(dialog);
        
        // è®¾ç½®å½“å‰é€‰ä¸­çŠ¶æ€
        updateSelectionState();
        
      } catch (error) {
        console.error('æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©å¯¹è¯æ¡†å¤±è´¥:', error);
        showSuccessToast('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼š' + error.message);
      }
    }
    
    // åˆ†æè®¾å¤‡ç±»å‹
    function analyzeDevice(device) {
      const label = device.label || '';
      const lowerLabel = label.toLowerCase();
      
      let type = 'æ™®é€šæ‘„åƒå¤´';
      let isRecommended = false;
      
      if (lowerLabel.includes('realsense') || lowerLabel.includes('intel')) {
        if (lowerLabel.includes('rgb') || lowerLabel.includes('color')) {
          type = 'RealSense RGBç›¸æœº';
          isRecommended = true;
        } else if (lowerLabel.includes('depth')) {
          type = 'RealSense æ·±åº¦ç›¸æœº';
        } else if (lowerLabel.includes('ir') || lowerLabel.includes('infrared')) {
          type = 'RealSense çº¢å¤–ç›¸æœº';
        } else {
          type = 'RealSense ç›¸æœº';
          isRecommended = true;
        }
      }
      
      return { type, isRecommended };
    }
    
    // åˆ›å»ºè®¾å¤‡é¡¹
    function createDeviceItem(device, canvasId) {
      const item = document.createElement('div');
      item.className = 'device-item';
      item.dataset.deviceId = device.deviceId || '';
      item.dataset.canvasId = canvasId;
      
      const name = document.createElement('div');
      name.className = 'device-name';
      name.textContent = device.label;
      item.appendChild(name);
      
      const info = document.createElement('div');
      info.className = 'device-info';
      info.textContent = device.deviceId ? `ID: ${device.deviceId.substring(0, 8)}...` : 'è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ‘„åƒå¤´';
      item.appendChild(info);
      
      if (device.type) {
        const type = document.createElement('div');
        type.className = `device-type ${device.isRecommended ? 'recommended' : 'other'}`;
        type.textContent = device.type;
        item.appendChild(type);
      }
      
      item.addEventListener('click', () => {
        // ç§»é™¤åŒä¸€ç”»å¸ƒä¸‹çš„å…¶ä»–é€‰ä¸­çŠ¶æ€
        const canvasItems = document.querySelectorAll(`.device-item[data-canvas-id="${canvasId}"]`);
        canvasItems.forEach(i => i.classList.remove('selected'));
        
        // æ·»åŠ é€‰ä¸­çŠ¶æ€
        item.classList.add('selected');
        
        // ä¿å­˜é€‰æ‹©
        if (canvasId === 'canvas1') {
          window.tempDeviceId1 = device.deviceId;
        } else {
          window.tempDeviceId2 = device.deviceId;
        }
      });
      
      return item;
    }
    
    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    function updateSelectionState() {
      const canvas1Items = document.querySelectorAll('.device-item[data-canvas-id="canvas1"]');
      const canvas2Items = document.querySelectorAll('.device-item[data-canvas-id="canvas2"]');
      
      // è®¾ç½®ç”»å¸ƒ1é€‰ä¸­çŠ¶æ€
      canvas1Items.forEach(item => {
        if (item.dataset.deviceId === (selectedDeviceId1 || '')) {
          item.classList.add('selected');
          window.tempDeviceId1 = selectedDeviceId1;
        }
      });
      
      // è®¾ç½®ç”»å¸ƒ2é€‰ä¸­çŠ¶æ€
      canvas2Items.forEach(item => {
        if (item.dataset.deviceId === (selectedDeviceId2 || '')) {
          item.classList.add('selected');
          window.tempDeviceId2 = selectedDeviceId2;
        }
      });
    }
    
    // æµ‹è¯•é€‰ä¸­çš„è®¾å¤‡
    async function testSelectedDevices() {
      const deviceId1 = window.tempDeviceId1;
      const deviceId2 = window.tempDeviceId2;
      
      // æµ‹è¯•ç”»å¸ƒ1è®¾å¤‡
      if (deviceId1) {
        const testStream1 = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: { exact: deviceId1 } }
        });
        testStream1.getTracks().forEach(track => track.stop());
      }
      
      // æµ‹è¯•ç”»å¸ƒ2è®¾å¤‡
      if (deviceId2 && deviceId2 !== deviceId1) {
        const testStream2 = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: { exact: deviceId2 } }
        });
        testStream2.getTracks().forEach(track => track.stop());
      }
    }
    
    // åº”ç”¨è®¾å¤‡é€‰æ‹©
    async function applyDeviceSelection() {
      selectedDeviceId1 = window.tempDeviceId1;
      selectedDeviceId2 = window.tempDeviceId2;
      
      // å¦‚æœæ­£åœ¨æ£€æµ‹ï¼Œéœ€è¦é‡æ–°å¯åŠ¨
      const wasDetecting = isDetecting;
      if (wasDetecting) {
        stopDetection();
      }
      
      // è®¾ç½®æ–°çš„æ‘„åƒå¤´
      await setupCameras();
      
      if (wasDetecting) {
        startDetection();
      }
    }
    
    // å¼€å§‹æ£€æµ‹
    async function startDetection() {
      if (isDetecting) return;
      
      try {
        statusElem.textContent = isVideoMode ? 'å‡†å¤‡å¤„ç†è§†é¢‘...' : 'æ­£åœ¨è¿æ¥æ‘„åƒå¤´...';
        
        if (!isVideoMode) {
          // å¦‚æœæœªè®¾ç½®è®¾å¤‡IDï¼Œåˆ™è‡ªåŠ¨é€‰æ‹©é»˜è®¤è®¾å¤‡ï¼ˆæ–°å¢é€»è¾‘ï¼‰
          if (!selectedDeviceId1 || !selectedDeviceId2) {
            await autoSelectDevices();
          }
          // è®¾ç½®ä¸¤ä¸ªæ‘„åƒå¤´
          await setupCameras();
        }
        
        // ç¡®ä¿è§†é¢‘æ’­æ”¾
        await video.play();
        if (!isVideoMode) {
          await video2.play();
        }
        console.log('è§†é¢‘æ’­æ”¾æˆåŠŸ');
        
        updateCanvasSize();
        setTimeout(updateCanvasSize, 500);
        
        isDetecting = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        analyzeBtn.disabled = false;
        statusElem.textContent = 'æ­£åœ¨è¿›è¡Œå§¿æ€æ£€æµ‹...';
        
        // éšè—æç¤ºä¿¡æ¯
        document.getElementById('detectionTips').style.display = 'none';
        
        // é‡ç½®æ•°æ®
        armMovementData = {
          left: [],
          right: [],
          recording: false
        };
        noPoseFrames1 = 0;
        noPoseFrames2 = 0;
        previousKeypoints = null;
        initKeypointBuffers();
        
        // å¼€å§‹æ£€æµ‹å¾ªç¯
        requestAnimationFrame(detectPose1);
        if (!isVideoMode) {
          requestAnimationFrame(detectPose2);
        }
        
      } catch (error) {
        console.error('å¯åŠ¨æ£€æµ‹å¤±è´¥:', error);
        handleDetectionError(error);
      }
    }
    
    // å¤„ç†æ£€æµ‹é”™è¯¯
    function handleDetectionError(error) {
      let errorMessage = 'å¯åŠ¨æ£€æµ‹å¤±è´¥';
      if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
        errorMessage = isVideoMode ? 'æ— æ³•è®¿é—®è§†é¢‘æ–‡ä»¶' : 'æ‘„åƒå¤´è®¿é—®è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ‘„åƒå¤´æƒé™';
      } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
        errorMessage = isVideoMode ? 'è§†é¢‘æ–‡ä»¶æ— æ³•è¯»å–' : 'æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡ï¼Œè¯·æ£€æŸ¥è¿æ¥';
      } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
        errorMessage = isVideoMode ? 'è§†é¢‘æ–‡ä»¶æŸåæˆ–æ— æ³•è¯»å–' : 'æ‘„åƒå¤´æ­£è¢«å…¶ä»–ç¨‹åºå ç”¨';
      } else if (error.message) {
        errorMessage += ': ' + error.message;
      }
      
      statusElem.textContent = errorMessage;
      
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
      if (currentStream2) {
        currentStream2.getTracks().forEach(track => track.stop());
        currentStream2 = null;
      }
    }
    
    // åœæ­¢æ£€æµ‹
    function stopDetection() {
      if (!isDetecting) return;
      
      // å¦‚æœæ­£åœ¨è®°å½•åŠ¨ä½œæ•°æ®ï¼Œå…ˆåˆ†ææ•°æ®
      if (armMovementData.recording) {
        analyzeArmMovements();
      }
      
      // åœæ­¢æ‰€æœ‰è§†é¢‘æµè½¨é“
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
      if (currentStream2) {
        currentStream2.getTracks().forEach(track => track.stop());
        currentStream2 = null;
      }

      if (isVideoMode && uploadedVideo) {
        uploadedVideo.pause();
        document.getElementById('uploadArea').classList.remove('hidden');
      }
      
      isDetecting = false;
      armMovementData.left = [];
      armMovementData.right = [];
      startBtn.disabled = false;
      stopBtn.disabled = true;
      analyzeBtn.disabled = true;
      statusElem.textContent = 'æ£€æµ‹å·²åœæ­¢';
      
      // æ¸…é™¤ç”»å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
      if (debugCtx) {
        debugCtx.clearRect(0, 0, debugCanvas.width, debugCanvas.height);
      }
      if (debugCtx2) {
        debugCtx2.clearRect(0, 0, debugCanvas2.width, debugCanvas2.height);
      }
    }
    
    // åˆ‡æ¢æ‰‹è‡‚åŠ¨ä½œåˆ†æ
    function toggleArmAnalysis() {
      if (!isDetecting) return;
      
      if (!armMovementData.recording) {
        armMovementData.left = [];
        armMovementData.right = [];
        armMovementData.recording = true;
        armMovementData.hasEnoughData = false;
        analyzeBtn.textContent = 'åœæ­¢åˆ†æåŠ¨ä½œ';
        statusElem.textContent = 'æ­£åœ¨è®°å½•æ‰‹è‡‚åŠ¨ä½œæ•°æ®...';
      } else {
        if (!armMovementData.hasEnoughData) {
          statusElem.textContent = 'æ•°æ®ä¸è¶³ï¼Œè¯·ç»§ç»­è¿åŠ¨å‡ ç§’é’Ÿ...';
          return;
        }
        
        armMovementData.recording = false;
        analyzeBtn.textContent = 'å¼€å§‹åˆ†æåŠ¨ä½œ';
        analyzeArmMovements();
      }
    }
    
    // åˆ†ææ‰‹è‡‚åŠ¨ä½œ
    function analyzeArmMovements() {
      if (armMovementData.left.length < 10 || armMovementData.right.length < 10) {
        statusElem.textContent = 'æ•°æ®ä¸è¶³ï¼Œè¯·å†æ¬¡å°è¯•å¹¶å¤šæ´»åŠ¨å‡ ç§’é’Ÿ';
        return;
      }
      
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      progressContainer.style.display = 'block';
      
      let progress = 0;
      const duration = 1000;
      const interval = 30;
      const steps = duration / interval;
      const increment = 100 / steps;
      
      const progressInterval = setInterval(() => {
        progress += increment;
        if (progress >= 100) {
          progress = 100;
          clearInterval(progressInterval);
          
          analysisResults.symmetry = calculateSymmetryScore();
          analysisResults.freedom = calculateFreedomScore();
          analysisResults.flexibility = calculateFlexibilityScore();
          
          setTimeout(() => {
            progressContainer.style.display = 'none';
            progressFill.style.width = '0%';
            
            displayAnalysisResults();
            armMovementData.left = [];
            armMovementData.right = [];
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.classList.add('active');
            
            statusElem.textContent = 'åˆ†æå®Œæˆï¼æ­£åœ¨ä¿å­˜ç»“æœ...';
            
            setTimeout(() => {
              analyzeBtn.classList.remove('active');
            }, 3000);
          }, 200);
        }
        
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `åˆ†æä¸­... ${Math.round(progress)}%`;
      }, interval);
    }
    
    // è®¡ç®—å¯¹ç§°æ€§è¯„åˆ†
    function calculateSymmetryScore() {
      let totalAngleDifference = 0;
      const minSamples = Math.min(armMovementData.left.length, armMovementData.right.length);
      
      for (let i = 0; i < minSamples; i++) {
        const leftAngle = armMovementData.left[i].angle;
        const rightAngle = armMovementData.right[i].angle;
        const angleDiff = Math.abs(leftAngle - rightAngle);
        totalAngleDifference += angleDiff;
      }
      
      const avgAngleDifference = totalAngleDifference / minSamples;
      let score = 10 - (avgAngleDifference / 30) * 10;
      return Math.max(0, Math.min(10, score)).toFixed(1);
    }
    
    // è®¡ç®—è‡ªç”±åº¦è¯„åˆ†
    function calculateFreedomScore() {
      const leftAngles = armMovementData.left.map(data => data.angle);
      const rightAngles = armMovementData.right.map(data => data.angle);

      const leftRange = Math.max(...leftAngles) - Math.min(...leftAngles);
      const rightRange = Math.max(...rightAngles) - Math.min(...rightAngles);
      const avgRange = (leftRange + rightRange) / 2;

      let leftDirectionChanges = 0;
      let rightDirectionChanges = 0;

      for (let i = 1; i < leftAngles.length; i++) {
        if ((leftAngles[i] - leftAngles[i-1]) * (leftAngles[i-1] - (leftAngles[i-2] || leftAngles[i-1])) < 0) {
          leftDirectionChanges++;
        }
      }
      for (let i = 1; i < rightAngles.length; i++) {
        if ((rightAngles[i] - rightAngles[i-1]) * (rightAngles[i-1] - (rightAngles[i-2] || rightAngles[i-1])) < 0) {
          rightDirectionChanges++;
        }
      }

      const avgDirectionChanges = (leftDirectionChanges + rightDirectionChanges) / 2;
      const rangeScore = Math.min(avgRange / 120, 1) * 6;
      const directionScore = Math.min(avgDirectionChanges / 10, 1) * 4;

      const leftZRange = Math.max(...armMovementData.left.map(d => d.shoulderPos.z)) -
                         Math.min(...armMovementData.left.map(d => d.shoulderPos.z));
      const rightZRange = Math.max(...armMovementData.right.map(d => d.shoulderPos.z)) -
                          Math.min(...armMovementData.right.map(d => d.shoulderPos.z));
      const avgZRange = (leftZRange + rightZRange) / 2;
      const zScore = Math.min(avgZRange / 500, 1) * 2;

      const totalScore = rangeScore + directionScore + zScore;
      return Math.max(0, Math.min(10, totalScore)).toFixed(1);
    }
    
    // è®¡ç®—çµæ´»åº¦è¯„åˆ†
    function calculateFlexibilityScore() {
      const leftMaxAngle = Math.max(...armMovementData.left.map(data => data.angle));
      const rightMaxAngle = Math.max(...armMovementData.right.map(data => data.angle));
      const avgMaxAngle = (leftMaxAngle + rightMaxAngle) / 2;
      
      let leftMaxSpeed = 0;
      let rightMaxSpeed = 0;
      
      for (let i = 1; i < armMovementData.left.length; i++) {
        const speed = Math.abs(armMovementData.left[i].angle - armMovementData.left[i-1].angle);
        if (speed > leftMaxSpeed) leftMaxSpeed = speed;
      }
      
      for (let i = 1; i < armMovementData.right.length; i++) {
        const speed = Math.abs(armMovementData.right[i].angle - armMovementData.right[i-1].angle);
        if (speed > rightMaxSpeed) rightMaxSpeed = speed;
      }
      
      const avgSpeed = (leftMaxSpeed + rightMaxSpeed) / 2;
      
      const angleScore = Math.min(avgMaxAngle / 180, 1) * 6;
      const speedScore = Math.min(avgSpeed / 10, 1) * 4;
      
      const totalScore = angleScore + speedScore;
      
      return Math.max(0, Math.min(10, totalScore)).toFixed(1);
    }
    
    // æ›´æ–°è¯„åˆ†æ˜¾ç¤º
    function displayAnalysisResults() {
      const symmetryPercent = Math.round(analysisResults.symmetry * 10);
      const freedomPercent = Math.round(analysisResults.freedom * 10);
      const flexibilityPercent = Math.round(analysisResults.flexibility * 10);
      const accuracyPercent = Math.round((symmetryPercent + freedomPercent + flexibilityPercent) / 3);
      
      document.getElementById('symmetryScore').textContent = symmetryPercent;
      document.getElementById('freedomScore').textContent = freedomPercent;
      document.getElementById('flexibilityScore').textContent = flexibilityPercent;
      document.getElementById('accuracyScore').textContent = accuracyPercent;
      
      document.getElementById('symmetryBar').style.width = `${symmetryPercent}%`;
      document.getElementById('freedomBar').style.width = `${freedomPercent}%`;
      document.getElementById('flexibilityBar').style.width = `${flexibilityPercent}%`;
      document.getElementById('accuracyBar').style.width = `${accuracyPercent}%`;
      
      updateAdvice(symmetryPercent, freedomPercent, flexibilityPercent);
      
      resultsElem.style.display = 'block';
      adviceSection.style.display = 'block';
      
      sendDataToUniApp(symmetryPercent, freedomPercent, flexibilityPercent, accuracyPercent);
    }
    
    // å‘uni-appå‘é€æ•°æ®å¹¶ä¸Šä¼ åˆ°åç«¯æ•°æ®åº“
    function sendDataToUniApp(symmetryDegree, freedomDegree, flexibilityDegree, accuracyPercent) {
      try {
        const now = new Date();
        const time = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ` +
                 `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
    
        const detectionData = {
          type: 'detection_data',
          data: {
            userId: userId,
            username: username,
            symmetryDegree: symmetryDegree,
            freedomDegree: freedomDegree,
            flexibilityDegree: flexibilityDegree,
            accuracyPercent: accuracyPercent,
            time: time
          }
        };
        
        console.log('å‡†å¤‡å‘é€æ•°æ®:', detectionData);
        
        // ç›´æ¥ä¸Šä¼ åˆ°åç«¯æ•°æ®åº“
        fetch('http://118.31.184.33:8080/user/insertHistory ', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(detectionData.data)
        })
        .then(response => {
          if (response.ok) {
            return response.json();
          }
          throw new Error('ç½‘ç»œå“åº”å¼‚å¸¸');
        })
        .then(data => {
          console.log('æ•°æ®ä¿å­˜æˆåŠŸ:', data);
          showSuccessToast('æ£€æµ‹ç»“æœå·²æˆåŠŸä¿å­˜ï¼');
          
          window.parent.postMessage({
            data: [detectionData]
          }, '*');
          console.log('æ•°æ®å·²å‘é€åˆ°uni-app');
        })
        .catch(error => {
          console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
          showSuccessToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
      }
      catch (error) {
        console.error('å‘é€æ•°æ®æ—¶å‡ºé”™:', error);
        showSuccessToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }
    
    // ==========================================
    // ä¸‹é¢æ˜¯æ–°å¢çš„ Excel ä¿å­˜åŠŸèƒ½ä»£ç 
    // ==========================================
    
    // ç”¨æ¥å­˜æ”¾æ–‡ä»¶ä½ç½®çš„å˜é‡
    let fileHandle = null;
    let directoryHandle = null;
    let isFileSystemMode = false;

    // åŠŸèƒ½1ï¼šç‚¹å‡»â€œè®¾ç½®ä¿å­˜è·¯å¾„â€æ—¶è¿è¡Œ
    async function setSavePath() {
      // æ£€æŸ¥æµè§ˆå™¨æ˜¯ä¸æ˜¯æ”¯æŒè¿™ä¸ªé«˜çº§åŠŸèƒ½
      if (!window.showDirectoryPicker && !window.showSaveFilePicker) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒé«˜çº§ä¿å­˜ï¼Œå°†ç›´æ¥ä¸‹è½½æ–‡ä»¶ã€‚\n(å»ºè®®ä½¿ç”¨ç”µè„‘ç‰ˆ Chrome æˆ– Edge)');
        return;
      }

      try {
        // è¯¢é—®ç”¨æˆ·æ˜¯æƒ³é€‰ä¸ªæ–‡ä»¶ï¼Œè¿˜æ˜¯é€‰ä¸ªæ–‡ä»¶å¤¹
        const choice = confirm("ç‚¹å‡»ã€ç¡®å®šã€‘é€‰æ‹©ä¸€ä¸ªå·²æœ‰çš„ Excel æ–‡ä»¶è¿›è¡Œè¿½åŠ ã€‚\nç‚¹å‡»ã€å–æ¶ˆã€‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œè‡ªåŠ¨æ›´æ–°è¡¨æ ¼ã€‚");
        
        if (choice) {
          // é€‰æ‹©å·²æœ‰æ–‡ä»¶
          const options = {
            types: [{
              description: 'Excel Files',
              accept: {'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']},
            }],
          };
          fileHandle = await window.showSaveFilePicker(options);
          directoryHandle = null; 
        } else {
          // é€‰æ‹©æ–‡ä»¶å¤¹
          directoryHandle = await window.showDirectoryPicker();
          fileHandle = null; 
        }

        isFileSystemMode = true;
        updatePathStatusUI(true);
        showSuccessToast('è·¯å¾„è®¾ç½®æˆåŠŸï¼');

      } catch (err) {
        if (err.name !== 'AbortError') {
          console.error(err);
          alert('æ— æ³•è®¿é—®è¯¥è·¯å¾„ï¼Œè¯·é‡è¯•ã€‚');
        }
      }
    }

    // åŠŸèƒ½2ï¼šæ›´æ–°ç•Œé¢ä¸Šçš„æç¤ºæ–‡å­—
    function updatePathStatusUI(isSet) {
      const statusDiv = document.getElementById('pathStatus');
      const btnText = document.getElementById('pathBtnText');
      
      if (isSet) {
        if (fileHandle) {
          statusDiv.textContent = `å½“å‰æ¨¡å¼ï¼šè¿½åŠ åˆ°æ–‡ä»¶ - ${fileHandle.name}`;
          btnText.textContent = "æ›´æ¢æ–‡ä»¶";
        } else if (directoryHandle) {
          statusDiv.textContent = `å½“å‰æ¨¡å¼ï¼šæ–‡ä»¶å¤¹æ¨¡å¼ - è‡ªåŠ¨æ›´æ–°è¡¨æ ¼`;
          btnText.textContent = "æ›´æ¢æ–‡ä»¶å¤¹";
        }
      } else {
        statusDiv.textContent = `å½“å‰æ¨¡å¼ï¼šç›´æ¥ä¸‹è½½ (é»˜è®¤ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹)`;
        btnText.textContent = "è®¾ç½®ä¿å­˜è·¯å¾„";
      }
    }

    // ç‚¹å‡»â€œä¿å­˜åˆ° Excelâ€æ—¶è¿è¡Œ
    async function saveToExcel() {
      // 1. æ£€æŸ¥æœ‰æ²¡æœ‰æ•°æ®
      const actionsDone = Object.values(actionData).filter(d => d.done).length;
      if (actionsDone === 0) {
        showSuccessToast('æš‚æ— æµ‹è¯•æ•°æ®ï¼Œè¯·å…ˆåšå‡ ä¸ªåŠ¨ä½œ');
        return;
      }

      // 2. å‡†å¤‡è¦ä¿å­˜çš„æ•°æ®
      const now = new Date();
      const timeStr = now.toLocaleString('zh-CN', { hour12: false }); // è·å–å½“å‰æ—¶é—´
      
      // è·å–æ€»åˆ†
      const totalScoreText = document.getElementById('totalScoreDisplay').textContent;
      const totalScore = parseInt(totalScoreText.replace('åˆ†', '')) || 0;
      
      // è·å–å·¦è‡‚ã€å³è‡‚ã€å¯¹ç§°åº¦åˆ†æ•°
      const detailText = document.getElementById('totalScoreDetail').textContent;
      let avgLeft = 0, avgRight = 0, avgSym = 0;
      const parts = detailText.split('|');
      parts.forEach(part => {
        if (part.includes('å·¦è‡‚å¹³å‡')) avgLeft = parseInt(part.match(/\d+/)[0]) || 0;
        if (part.includes('å³è‡‚å¹³å‡')) avgRight = parseInt(part.match(/\d+/)[0]) || 0;
        if (part.includes('å¯¹ç§°åº¦')) avgSym = parseInt(part.match(/\d+/)[0]) || 0;
      });

      // æŠŠæ•°æ®æ•´ç†æˆä¸€è¡Œ
      const rowData = {
        "è®°å½•æ—¶é—´": timeStr,
        "ç»¼åˆåº·å¤è¯„åˆ†": totalScore,
        "å·¦è‡‚å¹³å‡åˆ†": avgLeft,
        "å³è‡‚å¹³å‡åˆ†": avgRight,
        "å¯¹ç§°åº¦å¹³å‡åˆ†": avgSym,
        
        "è‚©å¤–ä¼¸-å·¦(Â°)": actionData.abduction.done ? Math.round(actionData.abduction.left) : '',
        "è‚©å¤–ä¼¸-å³(Â°)": actionData.abduction.done ? Math.round(actionData.abduction.right) : '',
        "è‚©å¤–ä¼¸-å¯¹ç§°åˆ†": actionData.abduction.done ? actionData.abduction.sym : '',
        
        "è‚©å‰æ›²-å·¦(Â°)": actionData.forward.done ? Math.round(actionData.forward.left) : '',
        "è‚©å‰æ›²-å³(Â°)": actionData.forward.done ? Math.round(actionData.forward.right) : '',
        "è‚©å‰æ›²-å¯¹ç§°åˆ†": actionData.forward.done ? actionData.forward.sym : '',
        
        "è‚©åä¼¸-å·¦(Â°)": actionData.backward.done ? Math.round(actionData.backward.left) : '',
        "è‚©åä¼¸-å³(Â°)": actionData.backward.done ? Math.round(actionData.backward.right) : '',
        "è‚©åä¼¸-å¯¹ç§°åˆ†": actionData.backward.done ? actionData.backward.sym : '',
        
        "è‚©å¤–æ—‹-å·¦(Â°)": actionData.external.done ? Math.round(actionData.external.left) : '',
        "è‚©å¤–æ—‹-å³(Â°)": actionData.external.done ? Math.round(actionData.external.right) : '',
        "è‚©å¤–æ—‹-å¯¹ç§°åˆ†": actionData.external.done ? actionData.external.sym : '',
        
        "è‚©å†…æ—‹-å·¦(Â°)": actionData.internal.done ? Math.round(actionData.internal.left) : '',
        "è‚©å†…æ—‹-å³(Â°)": actionData.internal.done ? Math.round(actionData.internal.right) : '',
        "è‚©å†…æ—‹-å¯¹ç§°åˆ†": actionData.internal.done ? actionData.internal.sym : '',
        
        "è‚˜æ›²-å·¦(Â°)": actionData.elbow.done ? Math.round(actionData.elbow.left) : '',
        "è‚˜æ›²-å³(Â°)": actionData.elbow.done ? Math.round(actionData.elbow.right) : '',
        "è‚˜æ›²-å¯¹ç§°åˆ†": actionData.elbow.done ? actionData.elbow.sym : ''
      };

      const btn = document.getElementById('saveReportBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span>â³</span> å¤„ç†ä¸­...';
      btn.disabled = true;

      try {
        let workbook;
        
        // --- æ¨¡å¼ Aï¼šæ–‡ä»¶è¿½åŠ æ•°æ® ---
        if (isFileSystemMode) {
          
          // å¦‚æœé€‰çš„æ˜¯æ–‡ä»¶å¤¹ï¼Œå°±å»æ‰¾é‚£ä¸ªæ–‡ä»¶
          if (directoryHandle) {
            const fileName = 'åº·å¤è®­ç»ƒè®°å½•.xlsx';
            fileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
          }
          
          // è¯»å–æ–‡ä»¶é‡Œçš„æ—§æ•°æ®
          const fileData = await fileHandle.getFile();
          const arrayBuffer = await fileData.arrayBuffer();
          workbook = XLSX.read(arrayBuffer, { type: 'array' });
          
          // æŠŠæ–°æ•°æ®åŠ è¿›å»
          const firstSheetName = workbook.SheetNames[0];
          const existingData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName]);
          existingData.push(rowData);
          
          // é‡æ–°ç”Ÿæˆè¡¨æ ¼
          const newWorksheet = XLSX.utils.json_to_sheet(existingData);
          workbook.Sheets[firstSheetName] = newWorksheet;
          
          // å†™å›æ–‡ä»¶
          const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
          const writable = await fileHandle.createWritable();
          await writable.write(excelBuffer);
          await writable.close();
          
          showSuccessToast('æ•°æ®å·²æˆåŠŸä¿å­˜ï¼');
        } 
        
        // --- ç›´æ¥ä¸‹è½½æ–°æ–‡ä»¶ ---
        else {
          workbook = XLSX.utils.book_new();
          const worksheet = XLSX.utils.json_to_sheet([rowData]);
          XLSX.utils.book_append_sheet(workbook, worksheet, "åº·å¤æ•°æ®");
          
          const dateStr = now.toISOString().slice(0,10);
          XLSX.writeFile(workbook, `åº·å¤è®­ç»ƒè®°å½•_${dateStr}.xlsx`);
          
          showSuccessToast('Excel å·²å¼€å§‹ä¸‹è½½');
        }

      } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        if (isFileSystemMode) {
          alert('å†™å…¥å¤±è´¥ï¼Œå·²åˆ‡æ¢ä¸ºä¸‹è½½æ¨¡å¼ã€‚');
          isFileSystemMode = false;
          updatePathStatusUI(false);
        } else {
          alert('ä¿å­˜å¤±è´¥: ' + error.message);
        }
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
	
    // æ›´æ–°å»ºè®®å†…å®¹
    function updateAdvice(symmetry, freedom, flexibility) {
      let advice = [];
      
      if (symmetry < 60) {
        advice.push('å·¦å³æ‰‹è‡‚åŠ¨ä½œä¸å¤Ÿå¯¹ç§°ï¼Œå»ºè®®æ³¨æ„ä¿æŒå¹³è¡¡');
      }
      
      if (freedom < 70) {
        advice.push('å½“å‰åŠ¨ä½œå¹…åº¦è¾ƒå°ï¼Œå»ºè®®é€‚å½“åŠ å¤§æ‰‹è‡‚æŠ¬èµ·è§’åº¦');
      }
      
      if (flexibility < 70) {
        advice.push('åŠ¨ä½œçµæ´»åº¦ä¸è¶³ï¼Œå»ºè®®å¢åŠ ç»ƒä¹ é¢‘ç‡');
      }
      
      advice.push('å»ºè®®æ¯ç»„åš1-2åˆ†é’ŸåŒ€é€Ÿè®­ç»ƒ');
      advice.push('å¦‚æ„Ÿä¸é€‚è¯·åŠæ—¶æš‚åœå¹¶å’¨è¯¢åŒ»ç”Ÿ');
      
      const adviceList = document.getElementById('adviceList');
      adviceList.innerHTML = advice.map(item => `<li>${item}</li>`).join('');
    }
    
    // æ›´æ–°æ—¶é—´æ˜¾ç¤º
    function updateCurrentTime() {
      const now = new Date();
      const dateStr = now.toLocaleDateString('zh-CN', { 
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        weekday: 'long'
      });
      const timeStr = now.toLocaleTimeString('zh-CN', { 
        hour: '2-digit',
        minute: '2-digit'
      });
      const timeText = `${dateStr} ${timeStr}`;
      document.querySelectorAll('.time').forEach(el => {
        el.textContent = timeText;
      });
    }
    
    // åˆå§‹åŒ–æ—¶æ·»åŠ æ—¶é—´æ›´æ–°
    window.addEventListener('DOMContentLoaded', () => {
      init();
      updateCurrentTime();
      setInterval(updateCurrentTime, 60000);
    });
    
    // å§¿æ€æ£€æµ‹å¾ªç¯ (ç”»å¸ƒ1) - ä¿®å¤ï¼šå§‹ç»ˆé‡ç»˜è§†é¢‘
    async function detectPose1(timestamp) {
      if (!isDetecting) return;
      
      const now = performance.now();
      frameCount++;
      if (now - lastFpsUpdate >= 1000) {
        fps = Math.round((frameCount * 1000) / (now - lastFpsUpdate));
        fpsElem.textContent = `FPS: ${fps}`;
        frameCount = 0;
        lastFpsUpdate = now;
      }
      
      try {
        // å§‹ç»ˆæ¸…ç©ºç”»å¸ƒå¹¶é‡ç»˜è§†é¢‘ï¼ˆå…³é”®ä¿®å¤ï¼šé˜²æ­¢æ®‹ç•™ï¼‰
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const poses = await detector.estimatePoses(video);
        
        if (poses.length > 0) {
          let smoothedKeypoints = smoothKeypoints(poses[0].keypoints);
          drawSkeletonOnVideo([{ keypoints: smoothedKeypoints }], ctx, debugCtx, canvas, debugCanvas, video);
          
          // ã€ä¿®æ”¹ã€‘è°ƒç”¨æ–°çš„åŠ¨ä½œæµ‹è¯•ç³»ç»Ÿ
          updateActionSystem(smoothedKeypoints);
		  
          if (armMovementData.recording) {
            collectArmData(smoothedKeypoints);
          }
          noPoseFrames1 = 0;  // é‡ç½®è®¡æ•°å™¨
        } else {
          noPoseFrames1++;
          if (noPoseFrames1 >= RESET_THRESHOLD) {
            previousKeypoints = null;
            initKeypointBuffers();  // é‡ç½®ç¼“å†²
            noPoseFrames1 = 0;
            console.log('é•¿æ—¶é—´æ— å§¿åŠ¿ï¼Œé‡ç½®å¹³æ»‘ç¼“å†²');
          }
        }
        
      } catch (error) {
        console.error('æ£€æµ‹è¿‡ç¨‹å‡ºé”™ (ç”»å¸ƒ1):', error);
      }
      
      requestAnimationFrame(detectPose1);
    }
    
    // å§¿æ€æ£€æµ‹å¾ªç¯ (ç”»å¸ƒ2) - ä¿®å¤ï¼šå§‹ç»ˆé‡ç»˜è§†é¢‘
    async function detectPose2(timestamp) {
      if (!isDetecting) return;
      
      const now = performance.now();
      frameCount2++;
      if (now - lastFpsUpdate2 >= 1000) {
        fps2 = Math.round((frameCount2 * 1000) / (now - lastFpsUpdate2));
        document.getElementById('fps2').textContent = `FPS: ${fps2}`;
        frameCount2 = 0;
        lastFpsUpdate2 = now;
      }
      
      try {
        // å§‹ç»ˆæ¸…ç©ºç”»å¸ƒå¹¶é‡ç»˜è§†é¢‘ï¼ˆå…³é”®ä¿®å¤ï¼šé˜²æ­¢æ®‹ç•™ï¼‰
        ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
        ctx2.drawImage(video2, 0, 0, canvas2.width, canvas2.height);
        
        const poses = await detector.estimatePoses(video2);
        
        if (poses.length > 0) {
          const smoothedKeypoints = smoothKeypoints(poses[0].keypoints);
          drawSkeletonOnVideo([{ keypoints: smoothedKeypoints }], ctx2, debugCtx2, canvas2, debugCanvas2, video2);
          noPoseFrames2 = 0;  // é‡ç½®è®¡æ•°å™¨
        } else {
          noPoseFrames2++;
          if (noPoseFrames2 >= RESET_THRESHOLD) {
            noPoseFrames2 = 0;
          }
        }
        
      } catch (error) {
        console.error('æ£€æµ‹è¿‡ç¨‹å‡ºé”™ (ç”»å¸ƒ2):', error);
      }
      
      requestAnimationFrame(detectPose2);
    }
    
    // å¢å¼ºå¹³æ»‘å¤„ç†å…³é”®ç‚¹ - è§£å†³é—ªçƒé—®é¢˜
    function smoothKeypoints(keypoints) {
      // å¦‚æœæ˜¯ç¬¬ä¸€å¸§ï¼Œæ²¡æœ‰ä¸Šä¸€å¸§çš„æ•°æ®ï¼Œå…ˆåˆå§‹åŒ–
      if (!previousKeypoints) {
        previousKeypoints = keypoints.map(kp => ({ ...kp })); // æ·±æ‹·è´å½“å‰å…³é”®ç‚¹
        updateBuffers(keypoints); // åˆå§‹åŒ–ç¼“å†²åŒº
        return keypoints;
      }
      
      // éå†æ‰€æœ‰17ä¸ªå…³é”®ç‚¹è¿›è¡Œå¹³æ»‘å¤„ç†
      const smoothedKeypoints = keypoints.map((keypoint, index) => {
        // è·å–å½“å‰å…³é”®ç‚¹åç§°ï¼ˆå¦‚ 'left_shoulder'ï¼‰
        const name = keypoints[index].name;
        // è·å–è¯¥å…³é”®ç‚¹å¯¹åº”çš„ç¼“å†²åŒºï¼ˆå­˜ä½ç½®ã€åˆ†æ•°ï¼‰
        const buffer = keypointBuffers[name];
        
        // ==========================================
        // æ ¸å¿ƒä¿®æ”¹åŒºåŸŸï¼šä¾§èº«ç¨³å®šæ€§å¢å¼º
        // ==========================================
        
        // å¦‚æœç½®ä¿¡åº¦ä½äºé˜ˆå€¼ (é»˜è®¤0.6)ï¼Œè¯´æ˜ç”µè„‘çœ‹ä¸æ¸…è¿™ä¸ªç‚¹
        if (keypoint.score < MIN_CONFIDENCE) {
          buffer.missingFrames++; // è®°å½•â€œçœ‹ä¸æ¸…â€è¿ç»­å‘ç”Ÿäº†å¤šå°‘å¸§
          
          // ã€å…³é”®ä¿®æ”¹ã€‘å°†é˜ˆå€¼ä» 3 æå‡è‡³ 15
          // ä»¥å‰ï¼šåªè¦3å¸§æ²¡çœ‹æ¸…ï¼ˆçº¦0.1ç§’ï¼‰å°±æ‰”æ‰ç‚¹ã€‚
          // ç°åœ¨ï¼šå…è®¸è¿ç»­15å¸§ï¼ˆçº¦0.5ç§’ï¼‰çœ‹ä¸æ¸…ï¼ŒæœŸé—´å¼ºè¡Œæ˜¾ç¤ºä¸Šä¸€å¸§ä½ç½®ã€‚
          // è¿™å¯¹ä¾§èº«é®æŒ¡éå¸¸æœ‰æ•ˆï¼Œèƒ½é˜²æ­¢éª¨æ¶ç¬é—´æ¶ˆå¤±æˆ–ä¹±è·³ã€‚
          if (buffer.missingFrames > 15) {
            // å¦‚æœçœŸçš„è¿ç»­ä¸¢å¤±å¤ªä¹…äº†ï¼Œé‚£å°±å½»åº•ä¸ç”»è¿™ä¸ªç‚¹äº†ï¼ˆæ˜¾ç¤ºä¸ºå¾—åˆ†0ï¼‰
            return { ...keypoint, score: 0, x: previousKeypoints[index].x, y: previousKeypoints[index].y }; 
          }
          
          // å¦‚æœè¿˜æ²¡è¶…è¿‡15å¸§ï¼Œæ‰§è¡Œâ€œä½ç½®é”å®šâ€ç­–ç•¥ï¼š
          // è¿”å›ä¸Šä¸€å¸§çš„ä½ç½® å’Œ åˆ†æ•°
          // è¿™æ ·åœ¨ä¾§èº«æ—¶ï¼Œå³ä½¿æ¨¡å‹æ£€æµ‹ä¸å‡†ï¼Œè§†è§‰ä¸Šéª¨æ¶ä¹Ÿä¼šâ€œå®šæ ¼â€åœ¨åŸåœ°ï¼Œä¸ä¼šä¹±é£
          return { 
            ...previousKeypoints[index], 
            score: previousKeypoints[index].score * 0.9 // åˆ†æ•°ç¨å¾®è¡°å‡ä¸€ç‚¹ï¼Œè¡¨ç¤ºè¿™æ˜¯â€œé¢„æµ‹â€å€¼
          };
        } else {
          // å¦‚æœè¿™ä¸€å¸§çœ‹æ¸…æ¥šäº†ï¼ˆç½®ä¿¡åº¦é«˜ï¼‰ï¼Œé‡ç½®ä¸¢å¤±è®¡æ•°å™¨
          buffer.missingFrames = 0;
        }
        
        // ==========================================
        // æ­£å¸¸å¹³æ»‘é€»è¾‘ï¼ˆå½“ç‚¹èƒ½çœ‹æ¸…æ—¶ï¼‰
        // ==========================================
        
        // 1. æ›´æ–°ç¼“å†²åŒºæ•°æ®ï¼ˆå­˜å…¥å½“å‰ä½ç½®å’Œåˆ†æ•°ï¼‰
        buffer.positions.push({ x: keypoint.x, y: keypoint.y });
        buffer.scores.push(keypoint.score);
        
        // ä¿æŒç¼“å†²åŒºå¤§å°å›ºå®šï¼ˆBUFFER_SIZE = 3ï¼‰ï¼Œç§»é™¤æœ€è€çš„æ•°æ®
        if (buffer.positions.length > BUFFER_SIZE) {
          buffer.positions.shift();
          buffer.scores.shift();
        }
        
        // 2. è®¡ç®—ç¼“å†²åŒºé‡Œçš„å¹³å‡å€¼ï¼ˆç®€å•çš„æŠ—å™ªï¼‰
        const avgX = buffer.positions.reduce((sum, p) => sum + p.x, 0) / buffer.positions.length;
        const avgY = buffer.positions.reduce((sum, p) => sum + p.y, 0) / buffer.positions.length;
        const avgScore = buffer.scores.reduce((sum, s) => sum + s, 0) / buffer.scores.length;
        
        // 3. ä½¿ç”¨ EMA (æŒ‡æ•°ç§»åŠ¨å¹³å‡) è¿›è¡Œæœ€ç»ˆå¹³æ»‘
        // å…¬å¼ï¼šæ–°ä½ç½® = æ—§ä½ç½® + (å¹³å‡ä½ç½® - æ—§ä½ç½®) * å¹³æ»‘ç³»æ•° (0.7)
        const prev = previousKeypoints[index];
        const emaX = prev.x + (avgX - prev.x) * SMOOTHING_FACTOR;
        const emaY = prev.y + (avgY - prev.y) * SMOOTHING_FACTOR;
        
        return {
          ...keypoint,
          x: emaX,
          y: emaY,
          score: Math.max(keypoint.score, avgScore) // æœ€ç»ˆå¾—åˆ†å–å½“å‰å’Œå¹³å‡çš„æœ€å¤§å€¼
        };
      });
      
      // æ›´æ–°â€œä¸Šä¸€å¸§â€æ•°æ®ï¼Œä¾›ä¸‹ä¸€æ¬¡å¾ªç¯ä½¿ç”¨
      previousKeypoints = smoothedKeypoints.map(kp => ({ ...kp }));
      
      return smoothedKeypoints;
    }
    
    // æ›´æ–°æ‰€æœ‰ç¼“å†²åŒº
    function updateBuffers(keypoints) {
      keypoints.forEach(kp => {
        const buffer = keypointBuffers[kp.name];
        buffer.positions.push({ x: kp.x, y: kp.y });
        buffer.scores.push(kp.score);
        if (buffer.positions.length > BUFFER_SIZE) {
          buffer.positions.shift();
          buffer.scores.shift();
        }
      });
    }
    
    // é¢„æµ‹å…³é”®ç‚¹ä½ç½®ï¼ˆæ”¹è¿›ç‰ˆï¼Œä½¿ç”¨ç¼“å†²åŒºï¼‰
    function predictKeypoint(keypoints, index) {
      const name = keypoints[index].name;
      const buffer = keypointBuffers[name];
      if (buffer.positions.length < 2) {
        return previousKeypoints[index] || keypoints[index];
      }
      
      const last = buffer.positions[buffer.positions.length - 1];
      const prev = buffer.positions[buffer.positions.length - 2];
      
      const dx = last.x - prev.x;
      const dy = last.y - prev.y;
      
      const avgScore = buffer.scores.reduce((sum, s) => sum + s, 0) / buffer.scores.length;
      const predictScore = avgScore * 0.6; // ä¿®æ”¹ï¼šé™ä½é¢„æµ‹scoreï¼Œæ›´å¿«ä½äºé˜ˆå€¼
      
      return {
        ...keypoints[index],
        x: last.x + dx * 0.5, // è½»å¾®é¢„æµ‹
        y: last.y + dy * 0.5,
        score: predictScore
      };
    }
    
    // æ”¶é›†æ‰‹è‡‚æ•°æ®
    function collectArmData(keypoints) {
      if (armMovementData.recording && armMovementData.left.length > 300) {
        armMovementData.recording = false;
        statusElem.textContent = 'æ•°æ®å·²æ”¶é›†å®Œæˆï¼';
        analyzeBtn.textContent = 'å¼€å§‹åˆ†æåŠ¨ä½œ';
        analyzeBtn.disabled = false;
        return;
      }
      
      const leftShoulder = findKeypoint(keypoints, 'left_shoulder');
      const leftElbow = findKeypoint(keypoints, 'left_elbow');
      const leftWrist = findKeypoint(keypoints, 'left_wrist');
      const rightShoulder = findKeypoint(keypoints, 'right_shoulder');
      const rightElbow = findKeypoint(keypoints, 'right_elbow');
      const rightWrist = findKeypoint(keypoints, 'right_wrist');

      if (leftShoulder && leftElbow && leftWrist && 
          rightShoulder && rightElbow && rightWrist) {

        const hasDepthLeft = leftShoulder.depth != null && leftElbow.depth != null && leftWrist.depth != null;
        const hasDepthRight = rightShoulder.depth != null && rightElbow.depth != null && rightWrist.depth != null;

        const leftAngle = hasDepthLeft
          ? calculateAngle3D(leftShoulder.x, leftShoulder.y, leftShoulder.depth || 0,
                             leftElbow.x, leftElbow.y, leftElbow.depth || 0,
                             leftWrist.x, leftWrist.y, leftWrist.depth || 0)
          : calculateAngle(leftShoulder.x, leftShoulder.y,
                           leftElbow.x, leftElbow.y,
                           leftWrist.x, leftWrist.y);

        const rightAngle = hasDepthRight
          ? calculateAngle3D(rightShoulder.x, rightShoulder.y, rightShoulder.depth || 0,
                             rightElbow.x, rightElbow.y, rightElbow.depth || 0,
                             rightWrist.x, rightWrist.y, rightWrist.depth || 0)
          : calculateAngle(rightShoulder.x, rightShoulder.y,
                           rightElbow.x, rightElbow.y,
                           rightWrist.x, rightWrist.y);

        armMovementData.left.push({
          angle: leftAngle,
          shoulderPos: { x: leftShoulder.x, y: leftShoulder.y, z: leftShoulder.depth || 0 },
          elbowPos: { x: leftElbow.x, y: leftElbow.y, z: leftElbow.depth || 0 },
          wristPos: { x: leftWrist.x, y: leftWrist.y, z: leftWrist.depth || 0 }
        });

        armMovementData.right.push({
          angle: rightAngle,
          shoulderPos: { x: rightShoulder.x, y: rightShoulder.y, z: rightShoulder.depth || 0 },
          elbowPos: { x: rightElbow.x, y: rightElbow.y, z: rightElbow.depth || 0 },
          wristPos: { x: rightWrist.x, y: rightWrist.y, z: rightWrist.depth || 0 }
        });

        if (armMovementData.left.length >= 10 && armMovementData.right.length >= 10) {
          armMovementData.hasEnoughData = true;
          statusElem.textContent = 'æ•°æ®å·²æ”¶é›†å®Œæˆï¼Œå¯ä»¥ç‚¹å‡»åœæ­¢åˆ†æ';
        }
      }
    }
    
    // è®¡ç®—è§’åº¦
    function calculateAngle(x1, y1, x2, y2, x3, y3) {
      if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2) || isNaN(x3) || isNaN(y3)) {
        console.warn('è§’åº¦è®¡ç®—å‚æ•°æ— æ•ˆ:', {x1, y1, x2, y2, x3, y3});
        return 0;
      }
      
      const a = Math.sqrt(Math.pow(x2 - x3, 2) + Math.pow(y2 - y3, 2));
      const b = Math.sqrt(Math.pow(x1 - x3, 2) + Math.pow(y1 - y3, 2));
      const c = Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2));
      
      const cosA = (Math.pow(b, 2) + Math.pow(c, 2) - Math.pow(a, 2)) / (2 * b * c);
      const clampedCosA = Math.max(-1, Math.min(1, cosA));
      
      const angle = Math.acos(clampedCosA) * (180 / Math.PI);
      
      return angle;
    }
    
    // 3D è§’åº¦è®¡ç®—å‡½æ•°
    function calculateAngle3D(x1, y1, z1, x2, y2, z2, x3, y3, z3) {
      const v1 = [x1 - x2, y1 - y2, z1 - z2];
      const v2 = [x3 - x2, y3 - y2, z3 - z2];
      const dot = v1[0]*v2[0] + v1[1]*v2[1] + v1[2]*v2[2];
      const mag1 = Math.sqrt(v1[0]**2 + v1[1]**2 + v1[2]**2);
      const mag2 = Math.sqrt(v2[0]**2 + v2[1]**2 + v2[2]**2);
      if (mag1 === 0 || mag2 === 0) return 0;
      const cosAngle = dot / (mag1 * mag2);
      const clamped = Math.max(-1, Math.min(1, cosAngle));
      return Math.acos(clamped) * (180 / Math.PI);
    }
    
    // æŸ¥æ‰¾ç‰¹å®šå…³é”®ç‚¹ (å¢å¼ºç‰ˆï¼šå…è®¸ä½ç½®ä¿¡åº¦ï¼Œç”¨äºä¾§èº«æ£€æµ‹)
    function findKeypoint(keypoints, name) {
      const keypoint = keypoints.find(kp => kp.name === name);
      if (keypoint && keypoint.score > 0) {
        return keypoint;
      }
      return null;
    }
    
    // ç»˜åˆ¶éª¨æ¶ï¼ˆç®€åŒ–ç‰ˆï¼Œåªç»˜åˆ¶éª¨æ¶ï¼Œä¸é‡ç»˜è§†é¢‘ï¼‰
    function drawSkeletonOnVideo(poses, currentCtx, currentDebugCtx, currentCanvas, currentDebugCanvas, currentVideo) {
      if (!poses || poses.length === 0) return;
      
      const videoWidth = currentCanvas.videoWidth || currentVideo.videoWidth;
      const videoHeight = currentCanvas.videoHeight || currentVideo.videoHeight;
      const scaleX = currentCanvas.width / videoWidth;
      const scaleY = currentCanvas.height / videoHeight;
      currentCanvas.videoRatioX = videoWidth / currentCanvas.width;
      currentCanvas.videoRatioY = videoHeight / currentCanvas.height;
      
      let displayScaleX = currentCanvas.videoRatioX || 1;
      let displayScaleY = currentCanvas.videoRatioY || 1;
      
      if (!currentCanvas.videoRatioX) {
        displayScaleX = (currentCanvas.videoWidth || currentVideo.videoWidth) / currentCanvas.width;
        displayScaleY = (currentCanvas.videoHeight || currentVideo.videoHeight) / currentCanvas.height;
        currentCanvas.videoRatioX = 1 / displayScaleX;
        currentCanvas.videoRatioY = 1 / displayScaleY;
      } else {
        const videoDisplayWidth = currentVideo.clientWidth;
        const videoDisplayHeight = currentVideo.clientHeight;
        displayScaleX = currentCanvas.width / videoDisplayWidth;
        displayScaleY = currentCanvas.height / videoDisplayHeight;
      }
      
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isAndroid = /Android/i.test(navigator.userAgent);
      
      if (debugMode) {
        currentDebugCtx.fillStyle = 'rgba(0,0,0,0.5)';
        currentDebugCtx.fillRect(10, currentDebugCanvas.height - 80, 300, 70);
        currentDebugCtx.fillStyle = 'white';
        currentDebugCtx.font = '12px Arial';
        
        currentDebugCtx.save();
        currentDebugCtx.scale(-1, 1);
        currentDebugCtx.translate(-currentDebugCanvas.width, 0);
        
        currentDebugCtx.fillText(`è®¾å¤‡: ${isMobile ? (isAndroid ? 'å®‰å“' : 'ç§»åŠ¨è®¾å¤‡') : 'æ¡Œé¢æµè§ˆå™¨'}`, 15, currentDebugCanvas.height - 65);
        currentDebugCtx.fillText(`ç”»å¸ƒ: ${currentCanvas.width}x${currentCanvas.height}, è§†é¢‘: ${currentCanvas.videoWidth || currentVideo.videoWidth}x${currentCanvas.videoHeight || currentVideo.videoHeight}`, 15, currentDebugCanvas.height - 50);
        currentDebugCtx.fillText(`å®¢æˆ·ç«¯å°ºå¯¸: ç”»å¸ƒ=${currentCanvas.clientWidth}x${currentCanvas.clientHeight}, è§†é¢‘=${currentVideo.clientWidth}x${currentVideo.clientHeight}`, 15, currentDebugCanvas.height - 35);
        currentDebugCtx.fillText(`ç¼©æ”¾: scaleX=${scaleX.toFixed(2)}, scaleY=${scaleY.toFixed(2)}`, 15, currentDebugCanvas.height - 20);
        
        currentDebugCtx.restore();
      }
      
      poses.forEach(pose => {
        const adjustedKeypoints = correctKeypoints(pose.keypoints, scaleX, scaleY);
        drawCustomSkeleton(adjustedKeypoints, currentCtx);
        drawKeypoints(adjustedKeypoints, currentCtx, currentDebugCtx, currentDebugCanvas);
      });
    }
    
    // ä¿®æ­£å…³é”®ç‚¹åæ ‡
    function correctKeypoints(keypoints, scaleX, scaleY) {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isAndroid = /Android/i.test(navigator.userAgent);
      
      return keypoints.map(keypoint => {
        const newKeypoint = { ...keypoint };
        
        newKeypoint.x = (keypoint.x * scaleX);
        newKeypoint.y = (keypoint.y * scaleY);
        
        const isMirrored = true;
        if (isMirrored) {
          newKeypoint.x = canvas.width - newKeypoint.x;
        }
        
        if (isAndroid) {
          const videoRatioX = canvas.videoRatioX || 1;
          const videoRatioY = canvas.videoRatioY || 1;
          newKeypoint.x = keypoint.x / videoRatioX;
          newKeypoint.y = keypoint.y / videoRatioY;
          
          if (Math.abs(1 - videoRatioY) > 0.1) {
            const potentialYOffset = (canvas.height - (canvas.videoHeight / videoRatioY)) / 2;
            if (potentialYOffset > 5) {
              newKeypoint.y -= potentialYOffset;
            }
          }
        } else {
          newKeypoint.x = keypoint.x * scaleX;
          newKeypoint.y = keypoint.y * scaleY;
        }
        
        newKeypoint.x = Math.max(0, Math.min(canvas.width, newKeypoint.x));
        newKeypoint.y = Math.max(0, Math.min(canvas.height, newKeypoint.y));
        
        return newKeypoint;
      });
    }
    
    // ç»˜åˆ¶è‡ªå®šä¹‰éª¨æ¶
    function drawCustomSkeleton(keypoints, currentCtx) {
      const keypointMap = {};
      keypoints.forEach(keypoint => {
        if (keypoint.score > MIN_CONFIDENCE) { // ä¿®æ”¹ï¼šä½¿ç”¨MIN_CONFIDENCEé˜ˆå€¼
          if (keypoint.x >= 0 && keypoint.x <= currentCtx.canvas.width && 
              keypoint.y >= 0 && keypoint.y <= currentCtx.canvas.height) {
            keypointMap[keypoint.name] = keypoint;
          }
        }
      });
      
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const mainLineWidth = isMobile ? 4 : 3;
      const otherLineWidth = isMobile ? 3 : 2;
      
      const leftArmConnections = [
        ['left_shoulder', 'left_elbow'],
        ['left_elbow', 'left_wrist']
      ];
      
      const rightArmConnections = [
        ['right_shoulder', 'right_elbow'],
        ['right_elbow', 'right_wrist']
      ];
      
      const otherConnections = [
        ['nose', 'left_eye'], 
        ['left_eye', 'left_ear'], 
        ['nose', 'right_eye'],
        ['right_eye', 'right_ear'],
        ['left_shoulder', 'right_shoulder'],
        ['left_shoulder', 'left_hip'],
        ['right_shoulder', 'right_hip'],
        ['left_hip', 'right_hip'],
        ['left_hip', 'left_knee'],
        ['left_knee', 'left_ankle'],
        ['right_hip', 'right_knee'],
        ['right_knee', 'right_ankle']
      ];
      
      currentCtx.lineWidth = mainLineWidth;
      currentCtx.strokeStyle = '#FF4081';
      drawConnections(leftArmConnections, keypointMap, currentCtx);
      
      currentCtx.strokeStyle = '#2196F3';
      drawConnections(rightArmConnections, keypointMap, currentCtx);
      
      currentCtx.lineWidth = otherLineWidth;
      currentCtx.strokeStyle = 'cyan';
      drawConnections(otherConnections, keypointMap, currentCtx);
    }
    
    // ç»˜åˆ¶è¿æ¥çº¿
    function drawConnections(connections, keypointMap, currentCtx) {
      currentCtx.lineCap = 'round';
      currentCtx.lineJoin = 'round';
      
      for (const [p1Name, p2Name] of connections) {
        const p1 = keypointMap[p1Name];
        const p2 = keypointMap[p2Name];
        
        if (p1 && p2 && p1.score > MIN_CONFIDENCE && p2.score > MIN_CONFIDENCE) { // ä¿®æ”¹ï¼šä½¿ç”¨MIN_CONFIDENCEé˜ˆå€¼
          currentCtx.beginPath();
          currentCtx.moveTo(p1.x, p1.y);
          currentCtx.lineTo(p2.x, p2.y);
          currentCtx.stroke();
        }
      }
    }
    
    // ç»˜åˆ¶å…³é”®ç‚¹
    function drawKeypoints(keypoints, currentCtx, currentDebugCtx, currentDebugCanvas) {
      keypoints.forEach(keypoint => {
        if (keypoint.score > MIN_CONFIDENCE) { // ä¿®æ”¹ï¼šä½¿ç”¨MIN_CONFIDENCEé˜ˆå€¼
          currentCtx.beginPath();
          currentCtx.arc(keypoint.x, keypoint.y, 5, 0, 2 * Math.PI);
          currentCtx.fillStyle = 'red';
          currentCtx.fill();
        }
      });
    }
    
    // æ›´æ–°ç”»å¸ƒå°ºå¯¸ï¼ˆä¿®æ”¹ç‰ˆï¼‰
    function updateCanvasSize() {
      // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ
      setTimeout(() => {
        if (video.videoWidth === 0 || video.videoHeight === 0) {
          setTimeout(updateCanvasSize, 100);
          return;
        }
        
        // æ–°å¢ï¼šå¼ºåˆ¶å®¹å™¨ä¿æŒå¹¶æ’ï¼Œè®¡ç®—åŠ¨æ€å®½åº¦
        const wrapper = document.querySelector('.canvas-wrapper');
        const containers = document.querySelectorAll('.container, .container2');
        const availableWidth = wrapper.clientWidth;
        const minContainerWidth = Math.min(350, availableWidth / 2 - 10);  // å‡å»gap
        containers.forEach(container => {
          container.style.minWidth = `${minContainerWidth}px`;
          container.style.width = '100%';  // å¼¹æ€§å¡«å……
        });
        
        let videoWidth1 = video.videoWidth;
        let videoHeight1 = video.videoHeight;
        const targetRatio = 4 / 3;
        const currentRatio = videoWidth1 / videoHeight1;
        if (Math.abs(currentRatio - targetRatio) > 0.1) {
          videoHeight1 = videoWidth1 / targetRatio;
        }
        canvas.videoWidth = videoWidth1;
        canvas.videoHeight = videoHeight1;
        canvas.videoRatioX = videoWidth1 / canvas.width;
        canvas.videoRatioY = videoHeight1 / canvas.height;
        
        if (!isVideoMode) {
          if (video2.videoWidth === 0 || video2.videoHeight === 0) {
            setTimeout(updateCanvasSize, 100);
            return;
          }
          let videoWidth2 = video2.videoWidth;
          let videoHeight2 = video2.videoHeight;
          const currentRatio2 = videoWidth2 / videoHeight2;
          if (Math.abs(currentRatio2 - targetRatio) > 0.1) {
            videoHeight2 = videoWidth2 / targetRatio;
          }
          canvas2.videoWidth = videoWidth2;
          canvas2.videoHeight = videoHeight2;
          canvas2.videoRatioX = videoWidth2 / canvas2.width;
          canvas2.videoRatioY = videoHeight2 / canvas2.height;
        }
        
        console.log('ç”»å¸ƒå°ºå¯¸æ›´æ–°å®Œæˆï¼Œå®¹å™¨æœ€å°å®½åº¦:', minContainerWidth);
        
        previousKeypoints = null;
        initKeypointBuffers(); // é‡ç½®ç¼“å†²åŒº
        
        if (isDetecting) {
          setTimeout(() => {
            requestAnimationFrame(detectPose1);
            if (!isVideoMode) {
              requestAnimationFrame(detectPose2);
            }
          }, 200);
        }
      }, 100);  // å¢åŠ å»¶è¿Ÿï¼Œé¿å…reflow
    }
    
    // åˆ‡æ¢åˆ°æ‘„åƒå¤´æ¨¡å¼
    async function switchToCamera() {
      document.getElementById('cameraMode').classList.add('active');
      document.getElementById('videoMode').classList.remove('active');
      document.getElementById('uploadArea').classList.add('hidden');
      document.querySelector('.container2').style.display = 'block';
      isVideoMode = false;
      
      if (uploadedVideo) {
        uploadedVideo.pause();
        uploadedVideo = null;
      }
      
      video.srcObject = null;
      video2.srcObject = null;
      
      if (isDetecting) {
        stopDetection();
      }

      armMovementData.recording = false;
      armMovementData.hasEnoughData = false;
      analyzeBtn.textContent = 'å¼€å§‹åˆ†æåŠ¨ä½œ';
      analyzeBtn.disabled = true;
      
      startBtn.disabled = false;
    }
    
    // åˆ‡æ¢åˆ°è§†é¢‘æ¨¡å¼
    function switchToVideo() {
      document.getElementById('videoMode').classList.add('active');
      document.getElementById('cameraMode').classList.remove('active');
      document.getElementById('uploadArea').classList.remove('hidden');
      document.querySelector('.container2').style.display = 'none';
      isVideoMode = true;
      
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
      if (currentStream2) {
        currentStream2.getTracks().forEach(track => track.stop());
        currentStream2 = null;
      }
      
      if (isDetecting) {
        stopDetection();
      }

      armMovementData.recording = false;
      armMovementData.hasEnoughData = false;
      analyzeBtn.textContent = 'å¼€å§‹åˆ†æåŠ¨ä½œ';
      analyzeBtn.disabled = true;
      
      startBtn.disabled = true;
    }
    
    // å¤„ç†ä¸Šä¼ çš„è§†é¢‘æ–‡ä»¶
    function handleVideoFile(file) {
      if (file.size > 200 * 1024 * 1024) {
        showSuccessToast('è§†é¢‘æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡200MB');
        return;
      }
      
      const validTypes = ['video/mp4', 'video/quicktime'];
      if (!validTypes.includes(file.type)) {
        showSuccessToast('è¯·ä¸Šä¼ MP4æˆ–MOVæ ¼å¼çš„è§†é¢‘');
        return;
      }
      
      const videoURL = URL.createObjectURL(file);
      
      video.src = videoURL;
      video.srcObject = null;
      
      document.getElementById('uploadArea').classList.add('hidden');
      
      startBtn.disabled = false;
      
      uploadedVideo = video;
      
      statusElem.textContent = `å·²é€‰æ‹©è§†é¢‘: ${file.name}`;

      video.addEventListener('click', function() {
        if (!isDetecting && isVideoMode) {
          document.getElementById('uploadArea').classList.remove('hidden');
          video.src = '';
          video.srcObject = null;
          uploadedVideo = null;
          statusElem.textContent = 'è¯·ä¸Šä¼ æ–°çš„è§†é¢‘æ–‡ä»¶';
        }
      });
    }

    // åˆ‡æ¢æ‘„åƒå¤´å‡½æ•°
    async function switchCamera() {
      if (isVideoMode) return;
      
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        
        if (videoDevices.length <= 1) {
          showSuccessToast('æœªæ‰¾åˆ°å…¶ä»–å¯ç”¨çš„æ‘„åƒå¤´è®¾å¤‡');
          return;
        }
        
        const dialog = document.createElement('div');
        dialog.style.position = 'fixed';
        dialog.style.top = '50%';
        dialog.style.left = '50%';
        dialog.style.transform = 'translate(-50%, -50%)';
        dialog.style.backgroundColor = 'white';
        dialog.style.padding = '20px';
        dialog.style.borderRadius = '8px';
        dialog.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
        dialog.style.zIndex = '1000';
        dialog.style.width = '80%';
        dialog.style.maxWidth = '400px';
        
        const title = document.createElement('h3');
        title.textContent = 'é€‰æ‹©æ‘„åƒå¤´';
        title.style.margin = '0 0 15px 0';
        title.style.fontSize = '18px';
        title.style.color = '#333';
        dialog.appendChild(title);
        
        const deviceList = document.createElement('div');
        deviceList.style.maxHeight = '300px';
        deviceList.style.overflowY = 'auto';
        deviceList.style.marginBottom = '15px';

        videoDevices.forEach((device, index) => {
          const deviceItem = document.createElement('div');
          deviceItem.style.padding = '10px';
          deviceItem.style.border = '1px solid #eee';
          deviceItem.style.marginBottom = '5px';
          deviceItem.style.borderRadius = '4px';
          deviceItem.style.cursor = 'pointer';
          deviceItem.style.transition = 'background-color 0.2s';
          
          const deviceName = document.createElement('div');
          let displayName = device.label || `æ‘„åƒå¤´ ${index + 1}`;
          deviceName.textContent = displayName;
          deviceName.style.fontWeight = 'bold';
          deviceName.style.marginBottom = '5px';

          const deviceId = document.createElement('div');
          deviceId.textContent = `ID: ${device.deviceId.substring(0, 8)}...`;
          deviceId.style.fontSize = '12px';
          deviceId.style.color = '#666';
          
          deviceItem.appendChild(deviceName);
          deviceItem.appendChild(deviceId);
          
          deviceItem.addEventListener('click', async () => {
            try {
              window.selectedVideoDeviceId = device.deviceId;
              
              const wasDetecting = isDetecting;
              if (wasDetecting) {
                stopDetection();
              }
              
              await setupCameras();
              
              if (wasDetecting) {
                startDetection();
              }
              
              document.body.removeChild(dialog);
              document.body.removeChild(overlay);
              
              statusElem.textContent = `å·²åˆ‡æ¢åˆ°: ${device.label || `æ‘„åƒå¤´ ${index + 1}`}`;
              
            } catch (error) {
              console.error('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥:', error);
              statusElem.textContent = 'åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥: ' + error.message;
            }
          });
          
          deviceItem.addEventListener('mouseover', () => {
            deviceItem.style.backgroundColor = '#f5f5f5';
          });
          
          deviceItem.addEventListener('mouseout', () => {
            deviceItem.style.backgroundColor = 'white';
          });
          
          deviceList.appendChild(deviceItem);
        });
        
        dialog.appendChild(deviceList);
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.padding = '8px 15px';
        cancelBtn.style.border = 'none';
        cancelBtn.style.borderRadius = '4px';
        cancelBtn.style.backgroundColor = '#f5f5f5';
        cancelBtn.style.cursor = 'pointer';
        cancelBtn.style.float = 'right';
        
        cancelBtn.addEventListener('click', () => {
          document.body.removeChild(dialog);
          document.body.removeChild(overlay);
        });
        
        dialog.appendChild(cancelBtn);
        
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
        overlay.style.zIndex = '999';
        
        overlay.addEventListener('click', () => {
          document.body.removeChild(dialog);
          document.body.removeChild(overlay);
        });
        
        document.body.appendChild(overlay);
        document.body.appendChild(dialog);
        
      } catch (error) {
        console.error('è·å–æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥:', error);
        statusElem.textContent = 'è·å–æ‘„åƒå¤´åˆ—è¡¨å¤±è´¥: ' + error.message;
      }
    }
    
    // è®¾ç½®æ‘„åƒå¤´
    async function setupCameras() {
      try {
        if (currentStream) currentStream.getTracks().forEach(track => track.stop());
        currentStream = await getVideoStream(selectedDeviceId1);
        video.srcObject = currentStream;
        
        if (currentStream2) currentStream2.getTracks().forEach(track => track.stop());
        currentStream2 = await getVideoStream(selectedDeviceId2);
        video2.srcObject = currentStream2;
        
      } catch (error) {
        console.error('è®¾ç½®æ‘„åƒå¤´å¤±è´¥:', error);
        statusElem.textContent = 'è®¾ç½®æ‘„åƒå¤´å¤±è´¥: ' + error.message;
        throw error;
      }
    }
    
    // è·å–è§†é¢‘æµ
    async function getVideoStream(deviceId) {
      const constraints = {
        video: deviceId ? {
          deviceId: { exact: deviceId },
          width: { ideal: 640 },
          height: { ideal: 480 },
          frameRate: { ideal: 30 }
        } : true,
        audio: false
      };
      
      try {
        return await navigator.mediaDevices.getUserMedia(constraints);
      } catch (error) {
        console.warn('ç²¾ç¡®é…ç½®å¤±è´¥ï¼Œå°è¯•åŸºç¡€é…ç½®:', error);
        const fallbackConstraints = {
          video: deviceId ? {
            deviceId: { exact: deviceId }
          } : true,
          audio: false
        };
        return await navigator.mediaDevices.getUserMedia(fallbackConstraints);
      }
    }
  </script>
</body>
</html>